
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق إدارة الري والشاحنات</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary-color: #2c5aa0;
            --secondary-color: #f8f9fa;
            --accent-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --dark-color: #343a40;
            --light-color: #ffffff;
        }

        .dark-mode {
            --primary-color: #4a90e2;
            --secondary-color: #2c3e50;
            --accent-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --dark-color: #1a1a1a;
            --light-color: #34495e;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--secondary-color);
            color: var(--dark-color);
            transition: all 0.3s ease;
        }

        .dark-mode body {
            background-color: var(--dark-color);
            color: var(--light-color);
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color), #1e3a8a);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .sidebar {
            position: fixed;
            top: 0;
            right: -300px;
            width: 300px;
            height: 100vh;
            background-color: var(--light-color);
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 1050;
            overflow-y: auto;
        }

        .dark-mode .sidebar {
            background-color: var(--light-color);
        }

        .sidebar.show {
            right: 0;
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1040;
            display: none;
        }

        .sidebar-overlay.show {
            display: block;
        }

        .main-content {
            margin-top: 80px;
            padding: 20px;
            min-height: calc(100vh - 80px);
        }

        .screen {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .home-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .home-card {
            background: var(--light-color);
            border-radius: 15px;
            padding: 30px 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .dark-mode .home-card {
            background: var(--light-color);
            color: var(--dark-color);
        }

        .home-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            border-color: var(--primary-color);
        }

        .home-card i {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .home-card h5 {
            color: var(--dark-color);
            font-weight: 600;
        }

        .dark-mode .home-card h5 {
            color: var(--dark-color);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), #1e3a8a);
            border: none;
            border-radius: 10px;
            padding: 10px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(44, 90, 160, 0.3);
        }

        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(44, 90, 160, 0.25);
        }

        .table {
            background: var(--light-color);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .dark-mode .table {
            background: var(--light-color);
            color: var(--dark-color);
        }

        .table th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
            border: none;
        }

        .table td {
            border-color: #e9ecef;
            vertical-align: middle;
        }

        .btn-sm {
            border-radius: 8px;
            padding: 5px 12px;
            font-size: 0.875rem;
        }

        .alert {
            border-radius: 10px;
            border: none;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), #1e3a8a);
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .stats-card {
            background: linear-gradient(135deg, var(--accent-color), #20c997);
            color: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stats-card h3 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary-color), #1e3a8a);
        }

        .login-card {
            background: var(--light-color);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }

        .font-size-small { font-size: 0.875rem; }
        .font-size-medium { font-size: 1rem; }
        .font-size-large { font-size: 1.125rem; }
        .font-size-xlarge { font-size: 1.25rem; }

        .font-family-arabic { font-family: 'Amiri', 'Times New Roman', serif; }
        .font-family-modern { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

        @media (max-width: 768px) {
            .home-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .home-card {
                padding: 20px 15px;
            }
            
            .home-card i {
                font-size: 2.5rem;
            }
            
            .sidebar {
                width: 280px;
            }
            
            .main-content {
                padding: 15px;
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner-border {
            color: var(--primary-color);
        }

        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        .slide-in {
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .receipt-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin: 20px 0;
        }

        .receipt-header {
            text-align: center;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .receipt-details {
            margin: 20px 0;
        }

        .receipt-details table {
            width: 100%;
            border-collapse: collapse;
        }

        .receipt-details td {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .receipt-total {
            background: var(--primary-color);
            color: white;
            font-weight: bold;
            text-align: center;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .back-arrow-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--primary-color);
            background: white;
            color: var(--primary-color);
            transition: all 0.3s ease;
        }

        .back-arrow-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: scale(1.1);
        }

        /* أنماط أزرار نوع الحمولة */
        .btn-group .btn {
            border-radius: 8px !important;
        }

        .btn-check:checked + .btn {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        /* تحسين مظهر جدول ترميز الشاحنات */
        #truckEncodingTable td {
            vertical-align: middle;
        }

        /* تحسين مظهر زر التصدير أثناء التحميل */
        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .fa-spin {
            animation: fa-spin 1s infinite linear;
        }

        @keyframes fa-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* تحسين التصميم للغة العربية */
        .arabic-report {
            direction: rtl;
            text-align: right;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .arabic-report table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .arabic-report th {
            background: linear-gradient(135deg, #2c5aa0, #1e3a8a);
            color: white;
            padding: 12px;
            border: 1px solid #ddd;
            font-weight: 600;
        }

        .arabic-report td {
            padding: 10px;
            border: 1px solid #e9ecef;
            background: white;
        }

        .arabic-report .stats-card {
            border-radius: 12px;
            padding: 20px;
            margin: 10px 0;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .arabic-report .stats-card:hover {
            transform: translateY(-5px);
        }

        .arabic-report .summary-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border-right: 4px solid #2c5aa0;
        }

        /* تحسين الأزرار */
        .btn-arabic {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: 600;
            border-radius: 8px;
            padding: 10px 20px;
        }

        /* تحسين العناوين */
        .arabic-title {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: 700;
            color: #2c5aa0;
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 3px solid #2c5aa0;
            padding-bottom: 10px;
        }

        /* تحسين الجداول */
        .table-arabic {
            direction: rtl;
        }

        .table-arabic th {
            background: #2c5aa0;
            color: white;
            font-weight: 600;
            text-align: center;
        }

        .table-arabic td {
            text-align: center;
            vertical-align: middle;
        }

        /* رموز إيموجي */
        .emoji-icon {
            font-size: 1.2em;
            margin-left: 5px;
        }

        /* تحسين البطاقات */
        .card-arabic {
            direction: rtl;
            text-align: right;
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .card-arabic:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        /* تحسين التنبيهات */
        .alert-arabic {
            direction: rtl;
            text-align: right;
            border: none;
            border-radius: 10px;
            font-weight: 500;
        }

        /* تصميم جديد لشاشة الري مع الساعات والدقائق */
        .time-input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .time-input-container .form-control {
            flex: 1;
        }

        .time-label {
            min-width: 60px;
            font-weight: 600;
        }

        @media print {
            .back-arrow-btn,
            .btn-secondary[onclick*="homeScreen"] {
                display: none !important;
            }
        }

        /* شاشة حسابات الشاحنات */
        .truck-accounts-card {
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .truck-accounts-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .account-balance {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
        }

        .balance-positive {
            color: #28a745;
        }

        .balance-negative {
            color: #dc3545;
        }

        .balance-zero {
            color: #6c757d;
        }

        .truck-account-details {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
        }

        .truck-transaction {
            border-bottom: 1px solid #e9ecef;
            padding: 10px 0;
        }

        .truck-transaction:last-child {
            border-bottom: none;
        }

        /* أنماط إدارة المصروفات */
        .expense-form-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .expense-table-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .expense-actions {
            display: flex;
            gap: 8px;
        }

        .expense-total-row {
            background-color: #f8f9fa;
            font-weight: bold;
            font-size: 1.1em;
        }

        .expense-type-badge {
            font-size: 0.8em;
            padding: 4px 8px;
            border-radius: 6px;
        }

        .expense-amount-cell {
            font-weight: 600;
            color: #dc3545;
        }

        .logo-upload-container {
            text-align: center;
            margin-bottom: 20px;
        }

        .logo-preview {
            width: 100px;
            height: 100px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            margin-bottom: 15px;
            object-fit: cover;
        }

        .logo-upload-btn {
            margin-top: 10px;
        }

        /* زر إضافة مصروف في الشاشة الرئيسية */
        .home-card.expense-card {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            color: white;
        }

        .home-card.expense-card i {
            color: white;
        }

        .home-card.expense-card h5 {
            color: white;
        }

        .home-card.expense-card:hover {
            background: linear-gradient(135deg, #ff5252, #ff7b7b);
        }
    </style>
</head>
<body>
    <!-- شاشة تسجيل الدخول -->
    <div id="loginScreen" class="login-container" style="display: none;">
        <div class="login-card">
            <div class="text-center mb-4">
                <i class="fas fa-water fa-3x text-primary mb-3"></i>
                <h3 id="loginAppName">تطبيق إدارة الري والشاحنات</h3>
            </div>
            <form id="loginForm">
                <div class="mb-3">
                    <label for="username" class="form-label">اسم المستخدم</label>
                    <input type="text" class="form-control" id="username" required>
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">كلمة المرور</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">تسجيل الدخول</button>
            </form>
        </div>
    </div>

    <!-- الشريط العلوي -->
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container-fluid">
            <div class="d-flex align-items-center">
                <button class="btn btn-outline-light me-3" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <img id="appLogo" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNmZmZmZmYiLz4KPHN2ZyB4PSI4IiB5PSI4IiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSI+CjxwYXRoIGQ9Ik0xMiAydjIwbTgtOEg0IiBzdHJva2U9IiMyYzVhYTAiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+Cjwvc3ZnPgo8L3N2Zz4K" alt="شعار التطبيق" class="me-2" style="width: 40px; height: 40px;">
                <h4 class="text-white mb-0" id="appName">تطبيق إدارة الري والشاحنات</h4>
            </div>
            <div class="d-flex align-items-center">
                <button class="btn btn-outline-light me-2" id="fontSizeToggle" title="تغيير حجم الخط">
                    <i class="fas fa-text-height"></i>
                </button>
                <button class="btn btn-outline-light" id="darkModeToggle" title="الوضع الليلي/النهاري">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- القائمة الجانبية -->
    <div class="sidebar" id="sidebar">
        <div class="p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5>الإعدادات</h5>
                <button class="btn btn-sm btn-outline-secondary" id="closeSidebar">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <ul class="list-unstyled">
                <li class="mb-3">
                    <button class="btn btn-outline-primary w-100 text-start" onclick="showScreen('appSettingsScreen')">
                        <i class="fas fa-cog me-2"></i>
                        تغيير الشعار واسم التطبيق
                    </button>
                </li>
                <li class="mb-3">
                    <button class="btn btn-outline-primary w-100 text-start" onclick="showScreen('loginSettingsScreen')">
                        <i class="fas fa-lock me-2"></i>
                        إعدادات تسجيل الدخول
                    </button>
                </li>
                <li class="mb-3">
                    <button class="btn btn-outline-primary w-100 text-start" onclick="showScreen('fuelSettingsScreen')">
                        <i class="fas fa-gas-pump me-2"></i>
                        ترميز الديزل/الساعات
                    </button>
                </li>
                <li class="mb-3">
                    <button class="btn btn-outline-primary w-100 text-start" onclick="showScreen('truckEncodingScreen')">
                        <i class="fas fa-truck-loading me-2"></i>
                        ترميز الشاحنات
                    </button>
                </li>
                <li class="mb-3">
                    <button class="btn btn-outline-primary w-100 text-start" onclick="showScreen('backupScreen')">
                        <i class="fas fa-download me-2"></i>
                        النسخة الاحتياطية والاستعادة
                    </button>
                </li>
                <li class="mb-3">
                    <button class="btn btn-outline-primary w-100 text-start" onclick="showScreen('aboutScreen')">
                        <i class="fas fa-info-circle me-2"></i>
                        حول التطبيق
                    </button>
                </li>
                <li class="mb-3">
                    <button class="btn btn-outline-primary w-100 text-start" onclick="showScreen('developerScreen')">
                        <i class="fas fa-user-tie me-2"></i>
                        المطور
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <!-- طبقة الخلفية للقائمة الجانبية -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- المحتوى الرئيسي -->
    <div class="main-content">
        <!-- الشاشة الرئيسية -->
        <div id="homeScreen" class="screen active">
            <div class="container-fluid">
                <div class="row mb-4">
                    <div class="col-12">
                        <h2 class="text-center mb-4">مرحباً بك في تطبيق إدارة الري والشاحنات</h2>
                    </div>
                </div>
                
                <div class="home-grid">
                    <div class="home-card" onclick="showScreen('customersScreen')">
                        <i class="fas fa-users"></i>
                        <h5>إضافة عملاء</h5>
                        <p class="text-muted">إدارة بيانات العملاء والمزارع</p>
                    </div>
                    
                    <div class="home-card" onclick="showScreen('irrigationScreen')">
                        <i class="fas fa-tint"></i>
                        <h5>طلب عملية ري/سقاية</h5>
                        <p class="text-muted">تسجيل عمليات الري والحسابات</p>
                    </div>
                    
                    <div class="home-card" onclick="showScreen('receiptScreen')">
                        <i class="fas fa-receipt"></i>
                        <h5>سند قبض</h5>
                        <p class="text-muted">تسجيل المدفوعات والمتبقي</p>
                    </div>
                    
                    <div class="home-card" onclick="showScreen('trucksScreen')">
                        <i class="fas fa-truck"></i>
                        <h5>إضافة شاحنات</h5>
                        <p class="text-muted">إدارة بيانات الشاحنات والسائقين</p>
                    </div>
                    
                    <div class="home-card" onclick="showScreen('truckLoadingScreen')">
                        <i class="fas fa-dolly"></i>
                        <h5>طلب تعبئة وايت</h5>
                        <p class="text-muted">تسجيل عمليات تعبئة الشاحنات</p>
                    </div>
                    
                    <div class="home-card" onclick="showScreen('truckAccountsScreen')">
                        <i class="fas fa-calculator"></i>
                        <h5>حسابات الشاحنات</h5>
                        <p class="text-muted">عرض وإدارة حسابات الشاحنات</p>
                    </div>
                    
                    <div class="home-card" onclick="showScreen('reportsScreen')">
                        <i class="fas fa-chart-bar"></i>
                        <h5>التقارير</h5>
                        <p class="text-muted">عرض التقارير والإحصائيات</p>
                    </div>
                    
                    <div class="home-card expense-card" onclick="showScreen('expensesScreen')">
                        <i class="fas fa-money-bill-wave"></i>
                        <h5>إدارة المصروفات</h5>
                        <p class="text-muted">إدارة مصروفات العمليات</p>
                    </div>
                    
                    <div class="home-card" onclick="showScreen('trashScreen')">
                        <i class="fas fa-trash"></i>
                        <h5>سلة المحذوفات</h5>
                        <p class="text-muted">استعادة العناصر المحذوفة</p>
                    </div>
                    
                    <div class="home-card" onclick="showScreen('settingsScreen')">
                        <i class="fas fa-cogs"></i>
                        <h5>الإعدادات</h5>
                        <p class="text-muted">إعدادات التطبيق العامة</p>
                    </div>
                    
                    <div class="home-card" onclick="showScreen('aboutScreen')">
                        <i class="fas fa-info-circle"></i>
                        <h5>حول التطبيق</h5>
                        <p class="text-muted">معلومات التطبيق والإصدار</p>
                    </div>
                    
                    <div class="home-card" onclick="showScreen('developerScreen')">
                        <i class="fas fa-user-tie"></i>
                        <h5>المطور</h5>
                        <p class="text-muted">معلومات الاتصال بالمطور</p>
                    </div>
                    
                    <div class="home-card" onclick="showScreen('backupScreen')">
                        <i class="fas fa-download"></i>
                        <h5>النسخة الاحتياطية</h5>
                        <p class="text-muted">حفظ واستعادة البيانات</p>
                    </div>
                    
                    <div class="home-card" onclick="showScreen('fuelSettingsScreen')">
                        <i class="fas fa-gas-pump"></i>
                        <h5>ترميز الديزل/الساعات</h5>
                        <p class="text-muted">إعداد أسعار الديزل والساعات</p>
                    </div>

                    <div class="home-card" onclick="showScreen('truckEncodingScreen')">
                        <i class="fas fa-truck-loading"></i>
                        <h5>ترميز الشاحنات</h5>
                        <p class="text-muted">إعداد أسعار الحملات</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- شاشة إدارة العملاء -->
        <div id="customersScreen" class="screen">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-users me-2"></i>إدارة العملاء</h3>
                    <button class="btn btn-secondary" onclick="showScreen('homeScreen')">
                        <i class="fas fa-arrow-right me-2"></i>العودة للرئيسية
                    </button>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5>إضافة عميل جديد</h5>
                            </div>
                            <div class="card-body">
                                <form id="customerForm">
                                    <div class="mb-3">
                                        <label for="customerName" class="form-label">اسم العميل</label>
                                        <input type="text" class="form-control" id="customerName" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="customerPhone" class="form-label">رقم الهاتف</label>
                                        <input type="tel" class="form-control" id="customerPhone" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="farmName" class="form-label">اسم الجرة (المزرعة)</label>
                                        <input type="text" class="form-control" id="farmName" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-plus me-2"></i>إضافة العميل
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>قائمة العملاء</h5>
                                <input type="text" class="form-control w-50" id="customerSearch" placeholder="البحث في العملاء...">
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>اسم العميل</th>
                                                <th>رقم الهاتف</th>
                                                <th>اسم المزرعة</th>
                                                <th>الرصيد</th>
                                                <th>الإجراءات</th>
                                            </tr>
                                        </thead>
                                        <tbody id="customersTable">
                                            <!-- سيتم ملء البيانات هنا -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- شاشة عمليات الري -->
        <div id="irrigationScreen" class="screen">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-tint me-2"></i>عمليات الري والسقاية</h3>
                    <button class="btn btn-secondary" onclick="showScreen('homeScreen')">
                        <i class="fas fa-arrow-right me-2"></i>العودة للرئيسية
                    </button>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5>تسجيل عملية ري جديدة</h5>
                            </div>
                            <div class="card-body">
                                <form id="irrigationForm">
                                    <div class="mb-3">
                                        <label for="irrigationCustomer" class="form-label">اختيار العميل</label>
                                        <select class="form-select" id="irrigationCustomer" required>
                                            <option value="">اختر العميل...</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="fuelBrought" class="form-label">كمية الديزل المجلوبة (لتر)</label>
                                        <input type="number" class="form-control" id="fuelBrought" step="0.1" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">مدة الري</label>
                                        <div class="time-input-container">
                                            <span class="time-label">ساعات:</span>
                                            <input type="number" class="form-control" id="hoursWorked" min="0" max="24" value="0" required>
                                            <span class="time-label">دقائق:</span>
                                            <input type="number" class="form-control" id="minutesWorked" min="0" max="59" value="0" required>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">الحسابات التلقائية</label>
                                        <div class="bg-light p-3 rounded">
                                            <p class="mb-1">إجمالي الوقت: <span id="totalTime">0</span> ساعة</p>
                                            <p class="mb-1">الديزل المستهلك: <span id="fuelConsumed">0</span> لتر</p>
                                            <p class="mb-1">القيمة الإجمالية: <span id="totalCost">0</span> ريال</p>
                                            <p class="mb-0">المتبقي من الديزل: <span id="remainingFuel">0</span> لتر</p>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-plus me-2"></i>تسجيل العملية
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>سجل عمليات الري</h5>
                                <input type="text" class="form-control w-50" id="irrigationSearch" placeholder="البحث في العمليات...">
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>التاريخ</th>
                                                <th>العميل</th>
                                                <th>مدة الري</th>
                                                <th>الديزل المستهلك</th>
                                                <th>القيمة</th>
                                                <th>الإجراءات</th>
                                            </tr>
                                        </thead>
                                        <tbody id="irrigationTable">
                                            <!-- سيتم ملء البيانات هنا -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- شاشة سندات القبض -->
        <div id="receiptScreen" class="screen">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-receipt me-2"></i>سندات القبض</h3>
                    <button class="btn btn-secondary" onclick="showScreen('homeScreen')">
                        <i class="fas fa-arrow-right me-2"></i>العودة للرئيسية
                    </button>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5>تسجيل سند قبض جديد</h5>
                            </div>
                            <div class="card-body">
                                <form id="receiptForm">
                                    <div class="mb-3">
                                        <label class="form-label">نوع المستلم</label>
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="recipientType" id="customerType" value="customer" checked onchange="toggleRecipientType()">
                                            <label class="btn btn-outline-primary" for="customerType">عميل</label>
                                            
                                            <input type="radio" class="btn-check" name="recipientType" id="truckType" value="truck" onchange="toggleRecipientType()">
                                            <label class="btn btn-outline-primary" for="truckType">شاحنة</label>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3" id="customerRecipient">
                                        <label for="receiptCustomer" class="form-label">اختيار العميل</label>
                                        <select class="form-select" id="receiptCustomer" onchange="updateCurrentBalance()">
                                            <option value="">اختر العميل...</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3" id="truckRecipient" style="display: none;">
                                        <label for="receiptTruck" class="form-label">اختيار الشاحنة</label>
                                        <select class="form-select" id="receiptTruck" onchange="updateCurrentBalance()">
                                            <option value="">اختر الشاحنة...</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">معلومات الحساب</label>
                                        <div class="bg-light p-3 rounded">
                                            <p class="mb-1">الرصيد الحالي: <span id="currentBalance">0</span> ريال</p>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="paymentAmount" class="form-label">مبلغ السداد</label>
                                        <input type="number" class="form-control" id="paymentAmount" step="0.01" required oninput="calculatePayment()">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">بعد السداد</label>
                                        <div class="bg-success text-white p-3 rounded">
                                            <p class="mb-1">المبلغ المدفوع: <span id="paidAmount">0</span> ريال</p>
                                            <p class="mb-0">المتبقي: <span id="remainingBalance">0</span> ريال</p>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-plus me-2"></i>تسجيل السند
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>سجل سندات القبض</h5>
                                <input type="text" class="form-control w-50" id="receiptSearch" placeholder="البحث في السندات...">
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>رقم السند</th>
                                                <th>التاريخ</th>
                                                <th>النوع</th>
                                                <th>المستلم</th>
                                                <th>المبلغ المدفوع</th>
                                                <th>الإجراءات</th>
                                            </tr>
                                        </thead>
                                        <tbody id="receiptTable">
                                            <!-- سيتم ملء البيانات هنا -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- شاشة إدارة الشاحنات -->
        <div id="trucksScreen" class="screen">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-truck me-2"></i>إدارة الشاحنات</h3>
                    <button class="btn btn-secondary" onclick="showScreen('homeScreen')">
                        <i class="fas fa-arrow-right me-2"></i>العودة للرئيسية
                    </button>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5>إضافة شاحنة جديدة</h5>
                            </div>
                            <div class="card-body">
                                <form id="truckForm">
                                    <div class="mb-3">
                                        <label for="driverName" class="form-label">اسم السائق/المالك</label>
                                        <input type="text" class="form-control" id="driverName" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="driverPhone" class="form-label">رقم الهاتف</label>
                                        <input type="tel" class="form-control" id="driverPhone" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="truckNumber" class="form-label">رقم الشاحنة</label>
                                        <input type="text" class="form-control" id="truckNumber">
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-plus me-2"></i>إضافة الشاحنة
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>قائمة الشاحنات</h5>
                                <input type="text" class="form-control w-50" id="truckSearch" placeholder="البحث في الشاحنات...">
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>اسم السائق</th>
                                                <th>رقم الهاتف</th>
                                                <th>رقم الشاحنة</th>
                                                <th>الرصيد</th>
                                                <th>الإجراءات</th>
                                            </tr>
                                        </thead>
                                        <tbody id="trucksTable">
                                            <!-- سيتم ملء البيانات هنا -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- شاشة تعبئة الشاحنات -->
        <div id="truckLoadingScreen" class="screen">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-dolly me-2"></i>طلب تعبئة وايت</h3>
                    <button class="btn btn-secondary" onclick="showScreen('homeScreen')">
                        <i class="fas fa-arrow-right me-2"></i>العودة للرئيسية
                    </button>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5>تسجيل عملية تعبئة جديدة</h5>
                            </div>
                            <div class="card-body">
                                <form id="truckLoadingForm">
                                    <div class="mb-3">
                                        <label for="loadingTruck" class="form-label">اختيار الشاحنة</label>
                                        <select class="form-select" id="loadingTruck" required onchange="updateLoadPrices()">
                                            <option value="">اختر الشاحنة...</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="loadCount" class="form-label">عدد الحملات</label>
                                        <input type="number" class="form-control" id="loadCount" min="1" required oninput="calculateLoading()">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">نوع الحمولة</label>
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="loadType" id="fullLoad" value="full" checked onchange="calculateLoading()">
                                            <label class="btn btn-outline-primary" for="fullLoad">حمولة كاملة</label>
                                            
                                            <input type="radio" class="btn-check" name="loadType" id="halfLoad" value="half" onchange="calculateLoading()">
                                            <label class="btn btn-outline-primary" for="halfLoad">نصف حمولة</label>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">أسعار الحمولة</label>
                                        <div class="bg-light p-3 rounded">
                                            <p class="mb-1">سعر الحمولة الكاملة: <span id="displayFullPrice">0</span> ريال</p>
                                            <p class="mb-0">سعر نصف الحمولة: <span id="displayHalfPrice">0</span> ريال</p>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">الحسابات</label>
                                        <div class="bg-success text-white p-3 rounded">
                                            <p class="mb-1">نوع الحمولة المحددة: <span id="selectedLoadType">حمولة كاملة</span></p>
                                            <p class="mb-1">سعر الحمولة: <span id="currentLoadPrice">0</span> ريال</p>
                                            <p class="mb-0">الإجمالي: <span id="loadingTotal">0</span> ريال</p>
                                        </div>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-plus me-2"></i>تسجيل العملية
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>سجل عمليات التعبئة</h5>
                                <input type="text" class="form-control w-50" id="loadingSearch" placeholder="البحث في العمليات...">
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>التاريخ</th>
                                                <th>الشاحنة</th>
                                                <th>عدد الحملات</th>
                                                <th>نوع الحمولة</th>
                                                <th>سعر الحمولة</th>
                                                <th>الإجمالي</th>
                                                <th>الإجراءات</th>
                                            </tr>
                                        </thead>
                                        <tbody id="loadingTable">
                                            <!-- سيتم ملء البيانات هنا -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- شاشة حسابات الشاحنات -->
        <div id="truckAccountsScreen" class="screen">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-calculator me-2"></i>حسابات الشاحنات</h3>
                    <button class="btn btn-secondary" onclick="showScreen('homeScreen')">
                        <i class="fas fa-arrow-right me-2"></i>العودة للرئيسية
                    </button>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stats-card bg-primary text-white">
                            <h3 id="totalTrucksCount">0</h3>
                            <p>إجمالي الشاحنات</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card bg-success text-white">
                            <h3 id="totalTruckRevenue">0</h3>
                            <p>إجمالي إيرادات الشاحنات</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card bg-info text-white">
                            <h3 id="totalTruckPayments">0</h3>
                            <p>إجمالي مدفوعات الشاحنات</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card bg-warning text-dark">
                            <h3 id="totalTruckBalance">0</h3>
                            <p>إجمالي أرصدة الشاحنات</p>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>تفاصيل حسابات الشاحنات</h5>
                                <input type="text" class="form-control w-50" id="truckAccountSearch" placeholder="البحث في الشاحنات...">
                            </div>
                            <div class="card-body">
                                <div class="row" id="truckAccountsList">
                                    <!-- سيتم ملء البيانات هنا -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- شاشة إدارة المصروفات -->
        <div id="expensesScreen" class="screen">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-money-bill-wave me-2"></i>إدارة المصروفات</h3>
                    <button class="btn btn-secondary" onclick="showScreen('homeScreen')">
                        <i class="fas fa-arrow-right me-2"></i>العودة للرئيسية
                    </button>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="card card-arabic">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">إضافة مصروف جديد</h5>
                            </div>
                            <div class="card-body">
                                <form id="expenseForm">
                                    <input type="hidden" id="expenseId" value="">
                                    <div class="mb-3">
                                        <label for="expenseType" class="form-label">اسم المصروف</label>
                                        <select class="form-select" id="expenseType" required>
                                            <option value="" disabled selected>اختر نوع المصروف</option>
                                            <option value="مصروفات عمال">مصروفات عمال</option>
                                            <option value="إصلاح للمضخة">إصلاح للمضخة</option>
                                            <option value="صرفة بيت">صرفة بيت</option>
                                            <option value="زيت للمضخة">زيت للمضخة</option>
                                            <option value="تخزينة">تخزينة</option>
                                            <option value="أخرى">أخرى (الخ..)</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="expenseAmount" class="form-label">المبلغ المصروف (ريال)</label>
                                        <input type="number" class="form-control" id="expenseAmount" min="0.01" step="0.01" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="expenseDescription" class="form-label">بيان المصروف</label>
                                        <input type="text" class="form-control" id="expenseDescription" required>
                                    </div>
                                    
                                    <div class="d-flex justify-content-end mt-3">
                                        <button type="submit" class="btn btn-primary me-2" id="saveExpenseBtn">
                                            <i class="fas fa-save me-2"></i>حفظ المصروف
                                        </button>
                                        <button type="button" class="btn btn-secondary" id="cancelEditExpenseBtn" style="display:none;">
                                            <i class="fas fa-times me-2"></i>إلغاء التعديل
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-8">
                        <div class="card card-arabic">
                            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                                <span>قائمة المصروفات</span>
                                <div class="d-flex">
                                    <button class="btn btn-sm btn-light me-2" onclick="printExpensesTable()">
                                        <i class="fas fa-print me-1"></i>طباعة
                                    </button>
                                    <button class="btn btn-sm btn-light" onclick="exportExpensesPDF()">
                                        <i class="fas fa-file-pdf me-1"></i>تصدير PDF
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- شريط البحث -->
                                <div class="mb-3">
                                    <input type="text" class="form-control" id="expenseSearchInput" onkeyup="filterExpenses()" placeholder="ابحث باسم المصروف أو البيان...">
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover" id="expensesTable">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>التاريخ</th>
                                                <th>اسم المصروف</th>
                                                <th>المبلغ (ريال)</th>
                                                <th>البيان</th>
                                                <th>الإجراءات</th>
                                            </tr>
                                        </thead>
                                        <tbody id="expensesTableBody">
                                            <!-- سيتم ملؤها بواسطة JavaScript -->
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <th colspan="3" class="text-end">إجمالي المصروفات:</th>
                                                <th id="totalExpensesAmount">0.00</th>
                                                <th colspan="2"></th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- شاشة التقارير -->
        <div id="reportsScreen" class="screen arabic-report">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-chart-bar me-2"></i>التقارير والإحصائيات</h3>
                    <button class="btn btn-secondary" onclick="showScreen('homeScreen')">
                        <i class="fas fa-arrow-right me-2"></i>العودة للرئيسية
                    </button>
                </div>

                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stats-card bg-primary text-white">
                            <h3 id="totalCustomers">0</h3>
                            <p>👥 إجمالي العملاء</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card bg-info text-white">
                            <h3 id="totalIrrigations">0</h3>
                            <p>💧 عمليات الري</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card bg-warning text-dark">
                            <h3 id="totalTrucks">0</h3>
                            <p>🚛 إجمالي الشاحنات</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card bg-success text-white">
                            <h3 id="totalRevenue">0</h3>
                            <p>💰 إجمالي الإيرادات</p>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <div class="card card-arabic">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">⚙️ إعدادات التقرير</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="reportPeriod" class="form-label">📅 الفترة الزمنية</label>
                                    <select class="form-select" id="reportPeriod">
                                        <option value="daily">📊 يومي</option>
                                        <option value="weekly">📈 أسبوعي</option>
                                        <option value="monthly" selected>📆 شهري</option>
                                        <option value="yearly">🎯 سنوي</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="reportCustomer" class="form-label">👤 العميل</label>
                                    <select class="form-select" id="reportCustomer">
                                        <option value="">👥 جميع العملاء</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="reportTruck" class="form-label">🚛 الشاحنة</label>
                                    <select class="form-select" id="reportTruck">
                                        <option value="">🚛 جميع الشاحنات</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="reportType" class="form-label">📋 نوع التقرير</label>
                                    <select class="form-select" id="reportType">
                                        <option value="irrigation">💧 عمليات الري</option>
                                        <option value="payments">💵 المدفوعات</option>
                                        <option value="trucks">🚛 الشاحنات</option>
                                        <option value="truckAccounts">🧾 حسابات الشاحنات</option>
                                        <option value="summary">📈 ملخص شامل</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary w-100 btn-arabic" onclick="generateReport()">
                                    <i class="fas fa-chart-line me-2"></i>إنشاء التقرير
                                </button>
                                
                                <hr class="my-4">
                                
                                <h6 class="text-center mb-3">📤 خيارات التصدير</h6>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-danger btn-arabic" onclick="exportOrShareReportPDF(event)">
                                        <i class="fas fa-file-pdf me-2"></i>تصدير PDF
                                    </button>
                                    <button class="btn btn-success btn-arabic" onclick="exportReportExcel()">
                                        <i class="fas fa-file-excel me-2"></i>تصدير Excel
                                    </button>
                                    <button class="btn btn-secondary btn-arabic" onclick="printReport()">
                                        <i class="fas fa-print me-2"></i>طباعة التقرير
                                    </button>
                                    <button class="btn btn-info btn-arabic text-white" onclick="shareReport()">
                                        <i class="fas fa-share-alt me-2"></i>مشاركة التقرير
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-8">
                        <div class="card card-arabic">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">📊 نتائج التقرير</h5>
                            </div>
                            <div class="card-body" id="reportResults">
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-chart-bar fa-4x mb-3 text-primary"></i>
                                    <h5>مرحباً بك في نظام التقارير</h5>
                                    <p class="mb-0">اختر الفلاتر وانقر على "إنشاء التقرير" لعرض النتائج</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- شاشة سلة المحذوفات -->
        <div id="trashScreen" class="screen">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-trash me-2"></i>سلة المحذوفات</h3>
                    <div>
                        <button class="btn btn-danger me-2" onclick="emptyTrash()">
                            <i class="fas fa-trash-alt me-2"></i>تفريغ السلة
                        </button>
                        <button class="btn btn-secondary" onclick="showScreen('homeScreen')">
                            <i class="fas fa-arrow-right me-2"></i>العودة للرئيسية
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5>العناصر المحذوفة</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>النوع</th>
                                        <th>البيانات</th>
                                        <th>تاريخ الحذف</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="trashTable">
                                    <!-- سيتم ملء البيانات هنا -->
                                </tbody>
                            </table>
                        </div>
                        <div id="emptyTrashMessage" class="text-center text-muted" style="display: none;">
                            <i class="fas fa-trash fa-3x mb-3"></i>
                            <p>سلة المحذوفات فارغة</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- شاشة الإعدادات -->
        <div id="settingsScreen" class="screen">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-cogs me-2"></i>الإعدادات</h3>
                    <button class="btn btn-secondary" onclick="showScreen('homeScreen')">
                        <i class="fas fa-arrow-right me-2"></i>العودة للرئيسية
                    </button>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5>إعدادات العرض</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="fontSizeSelect" class="form-label">حجم الخط</label>
                                    <select class="form-select" id="fontSizeSelect">
                                        <option value="small">صغير</option>
                                        <option value="medium" selected>متوسط</option>
                                        <option value="large">كبير</option>
                                        <option value="xlarge">كبير جداً</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="fontFamilySelect" class="form-label">نوع الخط</label>
                                    <select class="form-select" id="fontFamilySelect">
                                        <option value="modern" selected>خط حديث</option>
                                        <option value="arabic">خط عربي تقليدي</option>
                                    </select>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="darkModeSwitch">
                                    <label class="form-check-label" for="darkModeSwitch">
                                        الوضع الليلي
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5>إعدادات التطبيق</h5>
                            </div>
                            <div class="card-body">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="loginRequiredSwitch">
                                    <label class="form-check-label" for="loginRequiredSwitch">
                                        تفعيل شاشة تسجيل الدخول
                                    </label>
                                </div>
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="autoBackupSwitch">
                                    <label class="form-check-label" for="autoBackupSwitch">
                                        النسخ الاحتياطي التلقائي
                                    </label>
                                </div>
                                <button class="btn btn-primary w-100" onclick="saveSettings()">
                                    <i class="fas fa-save me-2"></i>حفظ الإعدادات
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- شاشة إعدادات التطبيق -->
        <div id="appSettingsScreen" class="screen">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-cog me-2"></i>إعدادات التطبيق</h3>
                    <button class="btn btn-secondary" onclick="showScreen('homeScreen')">
                        <i class="fas fa-arrow-right me-2"></i>العودة للرئيسية
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5>تخصيص التطبيق</h5>
                    </div>
                    <div class="card-body">
                        <form id="appSettingsForm">
                            <div class="mb-3">
                                <label for="newAppName" class="form-label">اسم التطبيق</label>
                                <input type="text" class="form-control" id="newAppName" value="تطبيق إدارة الري والشاحنات">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">شعار التطبيق</label>
                                <div class="logo-upload-container">
                                    <img id="logoPreview" class="logo-preview" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNmZmZmZmYiLz4KPHN2ZyB4PSI4IiB5PSI4IiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSI+CjxwYXRoIGQ9Ik0xMiAydjIwbTgtOEg0IiBzdHJva2U9IiMyYzVhYTAiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+Cjwvc3ZnPgo8L3N2Zz4K" alt="معاينة الشعار">
                                    <input type="file" class="form-control logo-upload-btn" id="appLogoFile" accept="image/*" style="display: none;">
                                    <button type="button" class="btn btn-outline-primary w-100" onclick="document.getElementById('appLogoFile').click()">
                                        <i class="fas fa-image me-2"></i>اختر شعاراً من الجهاز
                                    </button>
                                    <div class="form-text">الحجم الموصى به: 40x40 بكسل أو أكثر</div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>حفظ التغييرات
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- شاشة إعدادات تسجيل الدخول -->
        <div id="loginSettingsScreen" class="screen">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-lock me-2"></i>إعدادات تسجيل الدخول</h3>
                    <button class="btn btn-secondary" onclick="showScreen('homeScreen')">
                        <i class="fas fa-arrow-right me-2"></i>العودة للرئيسية
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5>إعدادات الأمان</h5>
                    </div>
                    <div class="card-body">
                        <form id="loginSettingsForm">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="enableLogin">
                                <label class="form-check-label" for="enableLogin">
                                    تفعيل شاشة تسجيل الدخول
                                </label>
                            </div>
                            <div id="loginCredentials" style="display: none;">
                                <div class="mb-3">
                                    <label for="adminUsername" class="form-label">اسم المستخدم</label>
                                    <input type="text" class="form-control" id="adminUsername" value="admin">
                                </div>
                                <div class="mb-3">
                                    <label for="adminPassword" class="form-label">كلمة المرور</label>
                                    <input type="password" class="form-control" id="adminPassword" value="123456">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>حفظ الإعدادات
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- شاشة ترميز الديزل والساعات -->
        <div id="fuelSettingsScreen" class="screen">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-gas-pump me-2"></i>ترميز الديزل والساعات</h3>
                    <button class="btn btn-secondary" onclick="showScreen('homeScreen')">
                        <i class="fas fa-arrow-right me-2"></i>العودة للرئيسية
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5>إعدادات الأسعار والاستهلاك</h5>
                    </div>
                    <div class="card-body">
                        <form id="fuelSettingsForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="hourlyRate" class="form-label">قيمة الساعة (ريال)</label>
                                        <input type="number" class="form-control" id="hourlyRate" step="0.01" value="50" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="fuelConsumptionRate" class="form-label">استهلاك الديزل في الساعة (لتر)</label>
                                        <input type="number" class="form-control" id="fuelConsumptionRate" step="0.1" value="5" required>
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                هذه الإعدادات ستؤثر على حسابات عمليات الري الجديدة فقط
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>حفظ الإعدادات
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- شاشة ترميز الشاحنات -->
        <div id="truckEncodingScreen" class="screen">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-truck-loading me-2"></i>ترميز الشاحنات</h3>
                    <button class="btn btn-secondary" onclick="showScreen('homeScreen')">
                        <i class="fas fa-arrow-right me-2"></i>العودة للرئيسية
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5>إعدادات أسعار الحملات للشاحنات</h5>
                    </div>
                    <div class="card-body">
                        <form id="truckEncodingForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="selectedTruck" class="form-label">اختيار الشاحنة</label>
                                        <select class="form-select" id="selectedTruck" required>
                                            <option value="">اختر الشاحنة...</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="truckLoadType" class="form-label">نوع الحمولة</label>
                                        <select class="form-select" id="truckLoadType" required>
                                            <option value="full">حمولة كاملة</option>
                                            <option value="half">نصف حمولة</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="fullLoadPrice" class="form-label">سعر الحمولة الكاملة (ريال)</label>
                                        <input type="number" class="form-control" id="fullLoadPrice" step="0.01" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="halfLoadPrice" class="form-label">سعر نصف الحمولة (ريال)</label>
                                        <input type="number" class="form-control" id="halfLoadPrice" step="0.01" required>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                هذه الإعدادات ستؤثر على حسابات عمليات التعبئة الجديدة فقط
                            </div>
                            
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>حفظ الإعدادات
                            </button>
                        </form>
                        
                        <!-- عرض الإعدادات المحفوظة -->
                        <div class="mt-4">
                            <h6>الإعدادات المحفوظة:</h6>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>اسم السائق</th>
                                            <th>الحمولة الكاملة</th>
                                            <th>نصف الحمولة</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="truckEncodingTable">
                                        <!-- سيتم ملء البيانات هنا -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- شاشة النسخ الاحتياطية -->
        <div id="backupScreen" class="screen">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-download me-2"></i>النسخ الاحتياطية</h3>
                    <button class="btn btn-secondary" onclick="showScreen('homeScreen')">
                        <i class="fas fa-arrow-right me-2"></i>العودة للرئيسية
                    </button>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>إنشاء نسخة احتياطية</h5>
                            </div>
                            <div class="card-body">
                                <p>احفظ جميع بياناتك في ملف JSON يمكن استعادته لاحقاً</p>
                                <button class="btn btn-success w-100" onclick="createBackup()">
                                    <i class="fas fa-download me-2"></i>تحميل النسخة الاحتياطية
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>استعادة نسخة احتياطية</h5>
                            </div>
                            <div class="card-body">
                                <p>استعد بياناتك من ملف النسخة الاحتياطية</p>
                                <input type="file" class="form-control mb-3" id="backupFile" accept=".json">
                                <button class="btn btn-warning w-100" onclick="restoreBackup()">
                                    <i class="fas fa-upload me-2"></i>استعادة النسخة الاحتياطية
                                </button>
                                <div class="alert alert-warning mt-3">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    تحذير: ستحل البيانات المستعادة محل البيانات الحالية
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- شاشة حول التطبيق -->
        <div id="aboutScreen" class="screen">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-info-circle me-2"></i>حول التطبيق</h3>
                    <button class="btn btn-secondary" onclick="showScreen('homeScreen')">
                        <i class="fas fa-arrow-right me-2"></i>العودة للرئيسية
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-body text-center">
                        <i class="fas fa-water fa-5x text-primary mb-4"></i>
                        <h2 class="mb-3">تطبيق إدارة الري والشاحنات</h2>
                        <p class="lead mb-4">نظام متكامل لإدارة عمليات الري والشاحنات</p>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h5>الإصدار</h5>
                                        <p class="text-primary">1.0.0</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h5>تاريخ الإصدار</h5>
                                        <p class="text-primary">2024</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h5>الحالة</h5>
                                        <p class="text-success">مستقر</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h5>الميزات الرئيسية:</h5>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success me-2"></i>إدارة العملاء والمزارع</li>
                                <li><i class="fas fa-check text-success me-2"></i>تسجيل عمليات الري والحسابات</li>
                                <li><i class="fas fa-check text-success me-2"></i>إدارة الشاحنات وعمليات التعبئة</li>
                                <li><i class="fas fa-check text-success me-2"></i>سندات القبض والمدفوعات</li>
                                <li><i class="fas fa-check text-success me-2"></i>التقارير والإحصائيات</li>
                                <li><i class="fas fa-check text-success me-2"></i>النسخ الاحتياطيات</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- شاشة المطور -->
        <div id="developerScreen" class="screen">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-user-tie me-2"></i>معلومات المطور</h3>
                    <button class="btn btn-secondary" onclick="showScreen('homeScreen')">
                        <i class="fas fa-arrow-right me-2"></i>العودة للرئيسية
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-body text-center">
                        <i class="fas fa-user-tie fa-5x text-primary mb-4"></i>
                        <h2 class="mb-3">عماد الدين المنصوب</h2>
                        <p class="lead mb-4">مطور تطبيقات الويب والهاتف المحمول</p>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <i class="fas fa-phone fa-2x text-primary mb-2"></i>
                                        <h5>رقم الهاتف</h5>
                                        <p><a href="tel:777617404" class="text-decoration-none">777617404</a></p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <i class="fas fa-envelope fa-2x text-primary mb-2"></i>
                                        <h5>البريد الإلكتروني</h5>
                                        <p><a href="mailto:amadalmansoub5@gmail.com" class="text-decoration-none">amadalmansoub5@gmail.com</a></p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <i class="fas fa-globe fa-2x text-primary mb-2"></i>
                                        <h5>الموقع الإلكتروني</h5>
                                        <p><a href="https://amadalmansoub.github.io/Amad/index.html" target="_blank" class="text-decoration-none">amadalmansoub.com</a></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h5>خدمات التطوير:</h5>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-code text-primary me-2"></i>تطوير تطبيقات الويب</li>
                                <li><i class="fas fa-mobile-alt text-primary me-2"></i>تطبيقات الهاتف المحمول</li>
                                <li><i class="fas fa-database text-primary me-2"></i>قواعد البيانات</li>
                                <li><i class="fas fa-cloud text-primary me-2"></i>الحلول السحابية</li>
                            </ul>
                        </div>
                        
                        <div class="mt-4">
                            <button class="btn btn-primary me-2" onclick="window.open('tel:777617404')">
                                <i class="fas fa-phone me-2"></i>اتصال
                            </button>
                            <button class="btn btn-success me-2" onclick="window.open('mailto:amadalmansoub5@gmail.com')">
                                <i class="fas fa-envelope me-2"></i>إرسال إيميل
                            </button>
                            <button class="btn btn-info" onclick="window.open('http://amadalmansoub.com', '_blank')">
                                <i class="fas fa-globe me-2"></i>زيارة الموقع
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal لتعديل البيانات -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalTitle">تعديل البيانات</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="editModalBody">
                    <!-- سيتم ملء المحتوى هنا -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" id="saveEditBtn">حفظ التغييرات</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal لعرض الإيصالات -->
    <div class="modal fade" id="receiptModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">إيصال</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="receiptModalBody">
                    <!-- سيتم ملء المحتوى هنا -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                    <button type="button" class="btn btn-primary" onclick="printReceipt()">
                        <i class="fas fa-print me-2"></i>طباعة
                    </button>
                    <button type="button" class="btn btn-success" onclick="exportReceiptPDF()">
                        <i class="fas fa-file-pdf me-2"></i>تصدير PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // 🔥🔥🔥 الدالة الأساسية المفقودة - أضيفت هنا 🔥🔥🔥
        function showScreen(screenId) {
            // إخفاء جميع الشاشات
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // عرض الشاشة المطلوبة
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
            } else {
                console.error('الشاشة غير موجودة:', screenId);
                return;
            }
            
            // إغلاق القائمة الجانبية
            closeSidebar();
            
            // تحديث البيانات حسب الشاشة
            switch(screenId) {
                case 'customersScreen':
                    updateCustomersTable();
                    updateCustomerSelects();
                    break;
                case 'trucksScreen':
                    updateTrucksTable();
                    updateTruckSelects();
                    break;
                case 'irrigationScreen':
                    updateIrrigationTable();
                    updateCustomerSelects();
                    break;
                case 'receiptScreen':
                    updateReceiptTable();
                    updateCustomerSelects();
                    updateTruckSelectsForReceipts();
                    break;
                case 'truckLoadingScreen':
                    updateTruckLoadingTable();
                    updateTruckSelects();
                    break;
                case 'truckAccountsScreen':
                    updateTruckAccountsStats();
                    updateTruckAccountsList();
                    break;
                case 'expensesScreen':
                    updateExpensesTable();
                    break;
                case 'reportsScreen':
                    updateReportsStats();
                    updateReportCustomerSelect();
                    updateReportTruckSelect();
                    break;
                case 'trashScreen':
                    updateTrashTable();
                    break;
                case 'settingsScreen':
                    // تحميل الإعدادات الحالية
                    document.getElementById('fontSizeSelect').value = appData.settings.fontSize;
                    document.getElementById('fontFamilySelect').value = appData.settings.fontFamily;
                    document.getElementById('darkModeSwitch').checked = appData.settings.darkMode;
                    document.getElementById('loginRequiredSwitch').checked = appData.settings.loginRequired;
                    document.getElementById('autoBackupSwitch').checked = appData.settings.autoBackup;
                    break;
                case 'appSettingsScreen':
                    document.getElementById('newAppName').value = appData.settings.appName;
                    break;
                case 'loginSettingsScreen':
                    document.getElementById('enableLogin').checked = appData.settings.loginRequired;
                    document.getElementById('adminUsername').value = appData.settings.username;
                    document.getElementById('adminPassword').value = appData.settings.password;
                    document.getElementById('loginCredentials').style.display = appData.settings.loginRequired ? 'block' : 'none';
                    break;
                case 'fuelSettingsScreen':
                    document.getElementById('hourlyRate').value = appData.settings.hourlyRate;
                    document.getElementById('fuelConsumptionRate').value = appData.settings.fuelConsumptionRate;
                    break;
                case 'truckEncodingScreen':
                    updateTruckEncodingSelects();
                    updateTruckEncodingTable();
                    break;
                case 'backupScreen':
                    // لا يحتاج تحميل بيانات إضافية
                    break;
                case 'aboutScreen':
                case 'developerScreen':
                    // شاشات المعلومات لا تحتاج تحميل بيانات
                    break;
            }
            
            // إضافة زر الرجوع تلقائياً لجميع الشاشات ما عدا الرئيسية
            addBackButton(screenId);
        }

        // متغيرات عامة
        let currentEditId = null;
        let currentEditType = null;
        let appData = {
            customers: [],
            trucks: [],
            irrigations: [],
            receipts: [],
            truckLoadings: [],
            expenses: [],
            trash: [],
            settings: {
                appName: 'تطبيق إدارة الري والشاحنات',
                appLogo: '',
                hourlyRate: 50,
                fuelConsumptionRate: 5,
                darkMode: false,
                fontSize: 'medium',
                fontFamily: 'modern',
                loginRequired: false,
                username: 'admin',
                password: '123456',
                autoBackup: false
            }
        };

        // إعدادات ترميز الشاحنات
        let truckEncodingSettings = {};

        // تحميل البيانات عند بدء التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            loadTruckEncodingSettings();
            initializeApp();
            setupEventListeners();
            checkLoginRequired();
            updateLogoutButton();
        });

        // تحميل البيانات من localStorage
        function loadData() {
            const savedData = localStorage.getItem('irrigationAppData');
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);

                    // دمج البيانات القديمة مع الجديدة مع الحفاظ على القيم الافتراضية
                    appData = {
                        ...appData,
                        ...parsedData,
                        settings: {
                            ...appData.settings,
                            ...(parsedData.settings || {})
                        }
                    };
                    
                    // التأكد من وجود مصفوفة المصروفات
                    if (!appData.expenses) {
                        appData.expenses = [];
                    }
                } catch (e) {
                    console.error('خطأ في تحميل البيانات:', e);
                }
            }
        }

        // تحميل إعدادات ترميز الشاحنات
        function loadTruckEncodingSettings() {
            const savedSettings = localStorage.getItem('truckEncodingSettings');
            if (savedSettings) {
                truckEncodingSettings = JSON.parse(savedSettings);
            }
        }

        // حفظ البيانات في localStorage
        function saveData() {
            try {
                localStorage.setItem('irrigationAppData', JSON.stringify(appData));
                return true;
            } catch (e) {
                console.error('خطأ في حفظ البيانات:', e);
                showAlert('خطأ في حفظ البيانات. تأكد من وجود مساحة كافية.', 'danger');
                return false;
            }
        }

        // حفظ إعدادات ترميز الشاحنات
        function saveTruckEncodingSettings() {
            localStorage.setItem('truckEncodingSettings', JSON.stringify(truckEncodingSettings));
        }

        // تهيئة التطبيق
        function initializeApp() {
            // تطبيق الإعدادات المحفوظة
            applySettings();
            
            // تحديث قوائم العملاء والشاحنات
            updateCustomerSelects();
            updateTruckSelects();
            updateTruckEncodingSelects();
            updateTruckSelectsForReceipts();
            updateReportTruckSelect();
            
            // تحديث الجداول
            updateCustomersTable();
            updateTrucksTable();
            updateIrrigationTable();
            updateReceiptTable();
            updateTruckLoadingTable();
            updateTruckEncodingTable();
            updateExpensesTable();
            updateTrashTable();
            updateReportsStats();
            updateTruckAccountsStats();
            updateTruckAccountsList();
            
            console.log('✅ التطبيق تم تهيئته بنجاح');
        }

        // تطبيق الإعدادات
        function applySettings() {
            // تطبيق اسم التطبيق والشعار
            document.getElementById('appName').textContent = appData.settings.appName;
            document.getElementById('loginAppName').textContent = appData.settings.appName;
            
            if (appData.settings.appLogo) {
                document.getElementById('appLogo').src = appData.settings.appLogo;
                document.getElementById('logoPreview').src = appData.settings.appLogo;
            }
            
            // تطبيق الوضع الليلي
            if (appData.settings.darkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeToggle').innerHTML = '<i class="fas fa-sun"></i>';
                document.getElementById('darkModeSwitch').checked = true;
            }
            
            // تطبيق حجم الخط
            document.body.className = document.body.className.replace(/font-size-\w+/g, '');
            document.body.classList.add('font-size-' + appData.settings.fontSize);
            document.getElementById('fontSizeSelect').value = appData.settings.fontSize;
            
            // تطبيق نوع الخط
            document.body.className = document.body.className.replace(/font-family-\w+/g, '');
            document.body.classList.add('font-family-' + appData.settings.fontFamily);
            document.getElementById('fontFamilySelect').value = appData.settings.fontFamily;
            
            // تطبيق إعدادات تسجيل الدخول
            document.getElementById('loginRequiredSwitch').checked = appData.settings.loginRequired;
            document.getElementById('enableLogin').checked = appData.settings.loginRequired;
            document.getElementById('adminUsername').value = appData.settings.username;
            document.getElementById('adminPassword').value = appData.settings.password;
            document.getElementById('loginCredentials').style.display = appData.settings.loginRequired ? 'block' : 'none';
            
            // تطبيق إعدادات الديزل والساعات
            document.getElementById('hourlyRate').value = appData.settings.hourlyRate;
            document.getElementById('fuelConsumptionRate').value = appData.settings.fuelConsumptionRate;
            
            // تطبيق إعدادات أخرى
            document.getElementById('autoBackupSwitch').checked = appData.settings.autoBackup;
        }

        // فحص متطلبات تسجيل الدخول
        function checkLoginRequired() {
            if (appData.settings.loginRequired) {
                const isLoggedIn = sessionStorage.getItem('isLoggedIn');
                if (!isLoggedIn) {
                    showLoginScreen();
                }
            }
        }

        // عرض شاشة تسجيل الدخول
        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.querySelector('.navbar').style.display = 'none';
            document.querySelector('.main-content').style.display = 'none';
        }

        // إخفاء شاشة تسجيل الدخول
        function hideLoginScreen() {
            document.getElementById('loginScreen').style.display = 'none';
            document.querySelector('.navbar').style.display = 'block';
            document.querySelector('.main-content').style.display = 'block';
        }

        // إعداد مستمعي الأحداث
        function setupEventListeners() {
            // القائمة الجانبية
            document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
            document.getElementById('closeSidebar').addEventListener('click', closeSidebar);
            document.getElementById('sidebarOverlay').addEventListener('click', closeSidebar);
            
            // الوضع الليلي
            document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
            document.getElementById('darkModeSwitch').addEventListener('change', toggleDarkMode);
            
            // تغيير حجم الخط
            document.getElementById('fontSizeToggle').addEventListener('click', cycleFontSize);
            document.getElementById('fontSizeSelect').addEventListener('change', changeFontSize);
            document.getElementById('fontFamilySelect').addEventListener('change', changeFontFamily);
            
            // نماذج الإدخال
            document.getElementById('customerForm').addEventListener('submit', addCustomer);
            document.getElementById('truckForm').addEventListener('submit', addTruck);
            document.getElementById('irrigationForm').addEventListener('submit', addIrrigation);
            document.getElementById('receiptForm').addEventListener('submit', addReceipt);
            document.getElementById('truckLoadingForm').addEventListener('submit', addTruckLoading);
            document.getElementById('expenseForm').addEventListener('submit', addExpense);
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('appSettingsForm').addEventListener('submit', saveAppSettings);
            document.getElementById('loginSettingsForm').addEventListener('submit', saveLoginSettings);
            document.getElementById('fuelSettingsForm').addEventListener('submit', saveFuelSettings);
            document.getElementById('truckEncodingForm').addEventListener('submit', saveTruckEncodingSettingsForm);
            
            // البحث
            document.getElementById('customerSearch').addEventListener('input', searchCustomers);
            document.getElementById('truckSearch').addEventListener('input', searchTrucks);
            document.getElementById('irrigationSearch').addEventListener('input', searchIrrigations);
            document.getElementById('receiptSearch').addEventListener('input', searchReceipts);
            document.getElementById('loadingSearch').addEventListener('input', searchLoadings);
            document.getElementById('truckAccountSearch').addEventListener('input', searchTruckAccounts);
            
            // حسابات تلقائية
            document.getElementById('fuelBrought').addEventListener('input', calculateIrrigation);
            document.getElementById('hoursWorked').addEventListener('input', calculateIrrigation);
            document.getElementById('minutesWorked').addEventListener('input', calculateIrrigation);
            document.getElementById('paymentAmount').addEventListener('input', calculatePayment);
            document.getElementById('receiptCustomer').addEventListener('change', updateCurrentBalance);
            
            // إعدادات تسجيل الدخول
            document.getElementById('enableLogin').addEventListener('change', function() {
                document.getElementById('loginCredentials').style.display = this.checked ? 'block' : 'none';
            });
            
            // زر حفظ التعديل
            document.getElementById('saveEditBtn').addEventListener('click', saveEdit);

            // التعامل مع رفع الشعار
            document.getElementById('appLogoFile').addEventListener('change', handleLogoUpload);
        }

        // التعامل مع رفع الشعار
        function handleLogoUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // التحقق من نوع الملف
            if (!file.type.match('image.*')) {
                showAlert('يرجى اختيار ملف صورة فقط', 'warning');
                return;
            }
            
            // التحقق من حجم الملف (5MB كحد أقصى)
            if (file.size > 5 * 1024 * 1024) {
                showAlert('حجم الملف كبير جداً. الحد الأقصى هو 5MB', 'warning');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const logoDataUrl = event.target.result;
                
                // تحديث المعاينة
                document.getElementById('logoPreview').src = logoDataUrl;
                
                // حفظ الشعار في الإعدادات
                appData.settings.appLogo = logoDataUrl;
                document.getElementById('appLogo').src = logoDataUrl;
                
                if (saveData()) {
                    showAlert('تم تحديث شعار التطبيق بنجاح', 'success');
                }
            };
            
            reader.readAsDataURL(file);
        }

        // تبديل القائمة الجانبية
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.toggle('show');
            overlay.classList.toggle('show');
        }

        // إغلاق القائمة الجانبية
        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.remove('show');
            overlay.classList.remove('show');
        }

        // إضافة زر الرجوع تلقائياً
        function addBackButton(screenId) {
            // لا نضيف زر الرجوع للشاشة الرئيسية
            if (screenId === 'homeScreen') return;
            
            const screen = document.getElementById(screenId);
            if (!screen) return;
            
            const header = screen.querySelector('.d-flex.justify-content-between.align-items-center.mb-4');
            if (!header) return;
            
            // إذا كان هناك زر رجوع موجود مسبقاً، لا نضيف آخر
            if (!header.querySelector('.back-arrow-btn')) {
                const backButton = document.createElement('button');
                backButton.className = 'back-arrow-btn btn btn-light btn-sm me-2';
                backButton.innerHTML = '<i class="fas fa-arrow-right"></i>';
                backButton.title = 'العودة للشاشة الرئيسية';
                backButton.onclick = function() {
                    showScreen('homeScreen');
                };
                
                // إضافة الزر بجانب زر العودة الموجود
                const existingBackButton = header.querySelector('button[onclick*="homeScreen"]');
                if (existingBackButton) {
                    existingBackButton.parentNode.insertBefore(backButton, existingBackButton);
                } else {
                    header.insertBefore(backButton, header.firstChild);
                }
            }
        }

        // تبديل الوضع الليلي
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            appData.settings.darkMode = document.body.classList.contains('dark-mode');
            
            const icon = document.getElementById('darkModeToggle').querySelector('i');
            icon.className = appData.settings.darkMode ? 'fas fa-sun' : 'fas fa-moon';
            
            document.getElementById('darkModeSwitch').checked = appData.settings.darkMode;
            saveData();
        }

        // تدوير حجم الخط
        function cycleFontSize() {
            const sizes = ['small', 'medium', 'large', 'xlarge'];
            const currentIndex = sizes.indexOf(appData.settings.fontSize);
            const nextIndex = (currentIndex + 1) % sizes.length;
            
            appData.settings.fontSize = sizes[nextIndex];
            changeFontSize();
        }

        // تغيير حجم الخط
        function changeFontSize() {
            const fontSize = document.getElementById('fontSizeSelect').value || appData.settings.fontSize;
            appData.settings.fontSize = fontSize;
            
            document.body.className = document.body.className.replace(/font-size-\w+/g, '');
            document.body.classList.add('font-size-' + fontSize);
            
            document.getElementById('fontSizeSelect').value = fontSize;
            saveData();
        }

        // تغيير نوع الخط
        function changeFontFamily() {
            const fontFamily = document.getElementById('fontFamilySelect').value;
            appData.settings.fontFamily = fontFamily;
            
            document.body.className = document.body.className.replace(/font-family-\w+/g, '');
            document.body.classList.add('font-family-' + fontFamily);
            
            saveData();
        }

        // تسجيل الدخول
        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === appData.settings.username && password === appData.settings.password) {
                sessionStorage.setItem('isLoggedIn', 'true');
                hideLoginScreen();
                showAlert('تم تسجيل الدخول بنجاح', 'success');
            } else {
                showAlert('اسم المستخدم أو كلمة المرور غير صحيحة', 'danger');
            }
        }

        // إضافة عميل جديد
        function addCustomer(e) {
            e.preventDefault();
            
            const customer = {
                id: Date.now(),
                name: document.getElementById('customerName').value,
                phone: document.getElementById('customerPhone').value,
                farmName: document.getElementById('farmName').value,
                balance: 0,
                createdAt: new Date().toISOString()
            };
            
            appData.customers.push(customer);
            saveData();
            updateCustomersTable();
            updateCustomerSelects();
            
            // إعادة تعيين النموذج
            document.getElementById('customerForm').reset();
            showAlert('تم إضافة العميل بنجاح', 'success');
        }

        // إضافة شاحنة جديدة
        function addTruck(e) {
            e.preventDefault();
            
            const truck = {
                id: Date.now(),
                driverName: document.getElementById('driverName').value,
                phone: document.getElementById('driverPhone').value,
                truckNumber: document.getElementById('truckNumber').value,
                balance: 0,
                createdAt: new Date().toISOString()
            };
            
            appData.trucks.push(truck);
            saveData();
            updateTrucksTable();
            updateTruckSelects();
            updateTruckEncodingSelects();
            updateTruckSelectsForReceipts();
            updateReportTruckSelect();
            
            // إعادة تعيين النموذج
            document.getElementById('truckForm').reset();
            showAlert('تم إضافة الشاحنة بنجاح', 'success');
        }

        // إضافة عملية ري جديدة
        function addIrrigation(e) {
            e.preventDefault();
            
            const customerId = parseInt(document.getElementById('irrigationCustomer').value);
            const fuelBrought = parseFloat(document.getElementById('fuelBrought').value);
            const hoursWorked = parseFloat(document.getElementById('hoursWorked').value);
            const minutesWorked = parseFloat(document.getElementById('minutesWorked').value);
            
            // حساب إجمالي الوقت بالساعات
            const totalHours = hoursWorked + (minutesWorked / 60);
            
            const fuelConsumed = totalHours * appData.settings.fuelConsumptionRate;
            const totalCost = totalHours * appData.settings.hourlyRate;
            const remainingFuel = fuelBrought - fuelConsumed;
            
            const irrigation = {
                id: Date.now(),
                customerId: customerId,
                fuelBrought: fuelBrought,
                hoursWorked: hoursWorked,
                minutesWorked: minutesWorked,
                totalHours: totalHours,
                fuelConsumed: fuelConsumed,
                totalCost: totalCost,
                remainingFuel: remainingFuel,
                createdAt: new Date().toISOString()
            };
            
            appData.irrigations.push(irrigation);
            
            // تحديث رصيد العميل
            const customer = appData.customers.find(c => c.id === customerId);
            if (customer) {
                customer.balance += totalCost;
            }
            
            saveData();
            updateIrrigationTable();
            updateCustomersTable();
            
            // إعادة تعيين النموذج
            document.getElementById('irrigationForm').reset();
            resetIrrigationCalculations();
            showAlert('تم تسجيل عملية الري بنجاح', 'success');
        }

        // تبديل نوع المستلم
        function toggleRecipientType() {
            const recipientType = document.querySelector('input[name="recipientType"]:checked').value;
            const customerRecipient = document.getElementById('customerRecipient');
            const truckRecipient = document.getElementById('truckRecipient');
            
            if (recipientType === 'customer') {
                customerRecipient.style.display = 'block';
                truckRecipient.style.display = 'none';
                // تحديث قائمة العملاء
                updateCustomerSelects();
            } else {
                customerRecipient.style.display = 'none';
                truckRecipient.style.display = 'block';
                // تحديث قائمة الشاحنات
                updateTruckSelectsForReceipts();
            }
            
            // إعادة تعيين الحقول
            document.getElementById('receiptCustomer').value = '';
            document.getElementById('receiptTruck').value = '';
            resetPaymentCalculations();
        }

        // تحديث قائمة الشاحنات للسندات
        function updateTruckSelectsForReceipts() {
            const select = document.getElementById('receiptTruck');
            if (!select) return;
            
            const currentValue = select.value;
            
            // مسح الخيارات الحالية (عدا الخيار الأول)
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            // إضافة الشاحنات
            appData.trucks.forEach(truck => {
                const option = document.createElement('option');
                option.value = truck.id;
                option.textContent = `${truck.driverName} - ${truck.truckNumber || 'غير محدد'}`;
                select.appendChild(option);
            });
            
            // استعادة القيمة المحددة
            select.value = currentValue;
        }

        // تحديث الرصيد الحالي
        function updateCurrentBalance() {
            const recipientType = document.querySelector('input[name="recipientType"]:checked').value;
            
            if (recipientType === 'customer') {
                const customerId = parseInt(document.getElementById('receiptCustomer').value);
                if (customerId) {
                    const customer = appData.customers.find(c => c.id === customerId);
                    if (customer) {
                        document.getElementById('currentBalance').textContent = customer.balance.toFixed(2);
                    }
                } else {
                    document.getElementById('currentBalance').textContent = '0';
                }
            } else {
                const truckId = parseInt(document.getElementById('receiptTruck').value);
                if (truckId) {
                    const truck = appData.trucks.find(t => t.id === truckId);
                    if (truck) {
                        document.getElementById('currentBalance').textContent = truck.balance.toFixed(2);
                    }
                } else {
                    document.getElementById('currentBalance').textContent = '0';
                }
            }
            
            resetPaymentCalculations();
        }

        // إضافة سند قبض جديد
        function addReceipt(e) {
            e.preventDefault();
            
            const recipientType = document.querySelector('input[name="recipientType"]:checked').value;
            const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
            
            if (recipientType === 'customer') {
                const customerId = parseInt(document.getElementById('receiptCustomer').value);
                
                if (!customerId) {
                    showAlert('يرجى اختيار العميل', 'warning');
                    return;
                }
                
                const receipt = {
                    id: Date.now(),
                    receiptNumber: 'R' + Date.now(),
                    customerId: customerId,
                    truckId: null,
                    amount: paymentAmount,
                    recipientType: 'customer',
                    createdAt: new Date().toISOString()
                };
                
                appData.receipts.push(receipt);
                
                // تحديث رصيد العميل
                const customer = appData.customers.find(c => c.id === customerId);
                if (customer) {
                    customer.balance -= paymentAmount;
                }
            } else {
                const truckId = parseInt(document.getElementById('receiptTruck').value);
                
                if (!truckId) {
                    showAlert('يرجى اختيار الشاحنة', 'warning');
                    return;
                }
                
                const receipt = {
                    id: Date.now(),
                    receiptNumber: 'R' + Date.now(),
                    customerId: null,
                    truckId: truckId,
                    amount: paymentAmount,
                    recipientType: 'truck',
                    createdAt: new Date().toISOString()
                };
                
                appData.receipts.push(receipt);
                
                // تحديث رصيد الشاحنة
                const truck = appData.trucks.find(t => t.id === truckId);
                if (truck) {
                    truck.balance -= paymentAmount;
                }
            }
            
            saveData();
            updateReceiptTable();
            updateCustomersTable();
            updateTrucksTable();
            
            // إعادة تعيين النموذج
            document.getElementById('receiptForm').reset();
            resetPaymentCalculations();
            showAlert('تم تسجيل سند القبض بنجاح', 'success');
        }

        // إضافة عملية تعبئة شاحنة جديدة
        function addTruckLoading(e) {
            e.preventDefault();
            
            const truckId = parseInt(document.getElementById('loadingTruck').value);
            const loadCount = parseInt(document.getElementById('loadCount').value);
            const loadType = document.querySelector('input[name="loadType"]:checked').value;
            
            if (!truckId) {
                showAlert('يرجى اختيار الشاحنة', 'warning');
                return;
            }
            
            if (!truckEncodingSettings[truckId]) {
                showAlert('لا توجد إعدادات أسعار لهذه الشاحنة. يرجى إضافة الإعدادات أولاً من شاشة ترميز الشاحنات.', 'warning');
                return;
            }
            
            const settings = truckEncodingSettings[truckId];
            const loadPrice = loadType === 'full' ? settings.fullLoadPrice : settings.halfLoadPrice;
            const total = loadCount * loadPrice;
            
            const loading = {
                id: Date.now(),
                truckId: truckId,
                loadCount: loadCount,
                loadType: loadType,
                loadPrice: loadPrice,
                total: total,
                createdAt: new Date().toISOString()
            };
            
            appData.truckLoadings.push(loading);
            
            // تحديث رصيد الشاحنة
            const truck = appData.trucks.find(t => t.id === truckId);
            if (truck) {
                truck.balance += total;
            }
            
            saveData();
            updateTruckLoadingTable();
            updateTrucksTable();
            
            // إعادة تعيين النموذج
            document.getElementById('truckLoadingForm').reset();
            resetLoadingCalculations();
            showAlert('تم تسجيل عملية التعبئة بنجاح', 'success');
        }

        // إضافة مصروف جديد
        function addExpense(e) {
            e.preventDefault();
            
            const expenseId = document.getElementById('expenseId').value;
            const expenseType = document.getElementById('expenseType').value;
            const expenseAmount = parseFloat(document.getElementById('expenseAmount').value);
            const expenseDescription = document.getElementById('expenseDescription').value;
            
            if (!expenseType || !expenseAmount || !expenseDescription) {
                showAlert('يرجى ملء جميع الحقول', 'warning');
                return;
            }
            
            const expense = {
                id: expenseId ? parseInt(expenseId) : Date.now(),
                type: expenseType,
                amount: expenseAmount,
                description: expenseDescription,
                createdAt: new Date().toISOString()
            };
            
            if (expenseId) {
                // تحديث المصروف الموجود
                const index = appData.expenses.findIndex(e => e.id === parseInt(expenseId));
                if (index !== -1) {
                    appData.expenses[index] = expense;
                }
            } else {
                // إضافة مصروف جديد
                appData.expenses.push(expense);
            }
            
            saveData();
            updateExpensesTable();
            
            // إعادة تعيين النموذج
            document.getElementById('expenseForm').reset();
            document.getElementById('expenseId').value = '';
            document.getElementById('saveExpenseBtn').innerHTML = '<i class="fas fa-save me-2"></i>حفظ المصروف';
            document.getElementById('cancelEditExpenseBtn').style.display = 'none';
            
            showAlert('تم حفظ المصروف بنجاح', 'success');
        }

        // حساب عملية الري
        function calculateIrrigation() {
            const fuelBrought = parseFloat(document.getElementById('fuelBrought').value) || 0;
            const hoursWorked = parseFloat(document.getElementById('hoursWorked').value) || 0;
            const minutesWorked = parseFloat(document.getElementById('minutesWorked').value) || 0;
            
            // حساب إجمالي الوقت بالساعات
            const totalHours = hoursWorked + (minutesWorked / 60);
            
            const fuelConsumed = totalHours * appData.settings.fuelConsumptionRate;
            const totalCost = totalHours * appData.settings.hourlyRate;
            const remainingFuel = fuelBrought - fuelConsumed;
            
            // تنسيق الوقت للعرض
            const displayTime = formatTimeForDisplay(hoursWorked, minutesWorked);
            
            document.getElementById('totalTime').textContent = displayTime;
            document.getElementById('fuelConsumed').textContent = fuelConsumed.toFixed(1);
            document.getElementById('totalCost').textContent = totalCost.toFixed(2);
            document.getElementById('remainingFuel').textContent = remainingFuel.toFixed(1);
        }

        // دالة مساعدة لتنسيق الوقت للعرض
        function formatTimeForDisplay(hours, minutes) {
            if (hours === 0 && minutes === 0) return "0 ساعة";
            
            let result = "";
            if (hours > 0) {
                result += hours + " ساعة";
            }
            if (minutes > 0) {
                if (result) result += " و ";
                result += minutes + " دقيقة";
            }
            return result;
        }

        // إعادة تعيين حسابات الري
        function resetIrrigationCalculations() {
            document.getElementById('totalTime').textContent = '0 ساعة';
            document.getElementById('fuelConsumed').textContent = '0';
            document.getElementById('totalCost').textContent = '0';
            document.getElementById('remainingFuel').textContent = '0';
        }

        // حساب الدفع
        function calculatePayment() {
            const recipientType = document.querySelector('input[name="recipientType"]:checked').value;
            const paymentAmount = parseFloat(document.getElementById('paymentAmount').value) || 0;
            
            if (recipientType === 'customer') {
                const customerId = parseInt(document.getElementById('receiptCustomer').value);
                if (customerId) {
                    const customer = appData.customers.find(c => c.id === customerId);
                    if (customer) {
                        const remainingBalance = customer.balance - paymentAmount;
                        
                        document.getElementById('paidAmount').textContent = paymentAmount.toFixed(2);
                        document.getElementById('remainingBalance').textContent = remainingBalance.toFixed(2);
                    }
                }
            } else {
                const truckId = parseInt(document.getElementById('receiptTruck').value);
                if (truckId) {
                    const truck = appData.trucks.find(t => t.id === truckId);
                    if (truck) {
                        const remainingBalance = truck.balance - paymentAmount;
                        
                        document.getElementById('paidAmount').textContent = paymentAmount.toFixed(2);
                        document.getElementById('remainingBalance').textContent = remainingBalance.toFixed(2);
                    }
                }
            }
        }

        // إعادة تعيين حسابات الدفع
        function resetPaymentCalculations() {
            document.getElementById('paidAmount').textContent = '0';
            document.getElementById('remainingBalance').textContent = '0';
        }

        // تحديث أسعار الحمولة عند اختيار الشاحنة
        function updateLoadPrices() {
            const truckId = parseInt(document.getElementById('loadingTruck').value);
            
            if (truckId && truckEncodingSettings[truckId]) {
                const settings = truckEncodingSettings[truckId];
                document.getElementById('displayFullPrice').textContent = settings.fullLoadPrice;
                document.getElementById('displayHalfPrice').textContent = settings.halfLoadPrice;
            } else {
                document.getElementById('displayFullPrice').textContent = '0';
                document.getElementById('displayHalfPrice').textContent = '0';
            }
            
            calculateLoading();
        }

        // حساب التعبئة
        function calculateLoading() {
            const truckId = parseInt(document.getElementById('loadingTruck').value);
            const loadCount = parseInt(document.getElementById('loadCount').value) || 0;
            const loadType = document.querySelector('input[name="loadType"]:checked').value;
            
            let loadPrice = 0;
            
            if (truckId && truckEncodingSettings[truckId]) {
                const settings = truckEncodingSettings[truckId];
                loadPrice = loadType === 'full' ? settings.fullLoadPrice : settings.halfLoadPrice;
            }
            
            const total = loadCount * loadPrice;
            
            document.getElementById('currentLoadPrice').textContent = loadPrice;
            document.getElementById('selectedLoadType').textContent = loadType === 'full' ? 'حمولة كاملة' : 'نصف حمولة';
            document.getElementById('loadingTotal').textContent = total.toFixed(2);
        }

        // إعادة تعيين حسابات التعبئة
        function resetLoadingCalculations() {
            document.getElementById('currentLoadPrice').textContent = '0';
            document.getElementById('selectedLoadType').textContent = 'حمولة كاملة';
            document.getElementById('loadingTotal').textContent = '0';
        }

        // تحديث قوائم العملاء
        function updateCustomerSelects() {
            const selects = ['irrigationCustomer', 'receiptCustomer', 'reportCustomer'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                const currentValue = select.value;
                
                // مسح الخيارات الحالية (عدا الخيار الأول)
                while (select.children.length > 1) {
                    select.removeChild(select.lastChild);
                }
                
                // إضافة العملاء
                appData.customers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.id;
                    option.textContent = `${customer.name} - ${customer.farmName}`;
                    select.appendChild(option);
                });
                
                // استعادة القيمة المحددة
                select.value = currentValue;
            });
        }

        // تحديث قوائم الشاحنات
        function updateTruckSelects() {
            const select = document.getElementById('loadingTruck');
            if (!select) return;
            
            const currentValue = select.value;
            
            // مسح الخيارات الحالية (عدا الخيار الأول)
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            // إضافة الشاحنات
            appData.trucks.forEach(truck => {
                const option = document.createElement('option');
                option.value = truck.id;
                option.textContent = `${truck.driverName} - ${truck.truckNumber || 'غير محدد'}`;
                select.appendChild(option);
            });
            
            // استعادة القيمة المحددة
            select.value = currentValue;
        }

        // تحديث قائمة الشاحنات في ترميز الشاحنات
        function updateTruckEncodingSelects() {
            const select = document.getElementById('selectedTruck');
            if (!select) return;
            
            const currentValue = select.value;
            
            // مسح الخيارات الحالية (عدا الخيار الأول)
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            // إضافة الشاحنات
            appData.trucks.forEach(truck => {
                const option = document.createElement('option');
                option.value = truck.id;
                option.textContent = `${truck.driverName} - ${truck.truckNumber || 'غير محدد'}`;
                select.appendChild(option);
            });
            
            // استعادة القيمة المحددة
            select.value = currentValue;
        }

        // تحديث قائمة الشاحنات في التقارير
        function updateReportTruckSelect() {
            const select = document.getElementById('reportTruck');
            if (!select) return;
            
            const currentValue = select.value;
            
            // مسح الخيارات الحالية (عدا الخيار الأول)
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            // إضافة الشاحنات
            appData.trucks.forEach(truck => {
                const option = document.createElement('option');
                option.value = truck.id;
                option.textContent = `${truck.driverName} - ${truck.truckNumber || 'غير محدد'}`;
                select.appendChild(option);
            });
            
            // استعادة القيمة المحددة
            select.value = currentValue;
        }

        // تحديث جدول العملاء
        function updateCustomersTable() {
            const tbody = document.getElementById('customersTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            appData.customers.forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.name}</td>
                    <td>${customer.phone}</td>
                    <td>${customer.farmName}</td>
                    <td class="${customer.balance >= 0 ? 'text-success' : 'text-danger'}">${customer.balance.toFixed(2)} ريال</td>
                    <td>
                        <button class="btn btn-sm btn-primary me-1" onclick="editCustomer(${customer.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger me-1" onclick="deleteCustomer(${customer.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="btn btn-sm btn-success me-1" onclick="callCustomer('${customer.phone}')">
                            <i class="fas fa-phone"></i>
                        </button>
                        <button class="btn btn-sm btn-info" onclick="messageCustomer('${customer.phone}')">
                            <i class="fas fa-sms"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // تحديث جدول الشاحنات
        function updateTrucksTable() {
            const tbody = document.getElementById('trucksTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            appData.trucks.forEach(truck => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${truck.driverName}</td>
                    <td>${truck.phone}</td>
                    <td>${truck.truckNumber || 'غير محدد'}</td>
                    <td class="${truck.balance >= 0 ? 'text-success' : 'text-danger'}">${truck.balance.toFixed(2)} ريال</td>
                    <td>
                        <button class="btn btn-sm btn-primary me-1" onclick="editTruck(${truck.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger me-1" onclick="deleteTruck(${truck.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="btn btn-sm btn-success me-1" onclick="callCustomer('${truck.phone}')">
                            <i class="fas fa-phone"></i>
                        </button>
                        <button class="btn btn-sm btn-info" onclick="messageCustomer('${truck.phone}')">
                            <i class="fas fa-sms"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // تحديث جدول عمليات الري
        function updateIrrigationTable() {
            const tbody = document.getElementById('irrigationTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            appData.irrigations.forEach(irrigation => {
                const customer = appData.customers.find(c => c.id === irrigation.customerId);
                const customerName = customer ? customer.name : 'عميل محذوف';
                const date = new Date(irrigation.createdAt).toLocaleDateString('ar-SA');
                const timeDisplay = formatTimeForDisplay(irrigation.hoursWorked, irrigation.minutesWorked);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${date}</td>
                    <td>${customerName}</td>
                    <td>${timeDisplay}</td>
                    <td>${irrigation.fuelConsumed.toFixed(1)} لتر</td>
                    <td>${irrigation.totalCost.toFixed(2)} ريال</td>
                    <td>
                        <button class="btn btn-sm btn-primary me-1" onclick="editIrrigation(${irrigation.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger me-1" onclick="deleteIrrigation(${irrigation.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="btn btn-sm btn-success" onclick="showIrrigationReceipt(${irrigation.id})">
                            <i class="fas fa-receipt"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // تحديث جدول سندات القبض
        function updateReceiptTable() {
            const tbody = document.getElementById('receiptTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            appData.receipts.forEach(receipt => {
                let recipientName = '';
                
                if (receipt.recipientType === 'customer') {
                    const customer = appData.customers.find(c => c.id === receipt.customerId);
                    recipientName = customer ? customer.name : 'عميل محذوف';
                } else {
                    const truck = appData.trucks.find(t => t.id === receipt.truckId);
                    recipientName = truck ? truck.driverName : 'شاحنة محذوفة';
                }
                
                const date = new Date(receipt.createdAt).toLocaleDateString('ar-SA');
                const typeText = receipt.recipientType === 'customer' ? 'عميل' : 'شاحنة';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${receipt.receiptNumber}</td>
                    <td>${date}</td>
                    <td>${typeText}</td>
                    <td>${recipientName}</td>
                    <td>${receipt.amount.toFixed(2)} ريال</td>
                    <td>
                        <button class="btn btn-sm btn-primary me-1" onclick="editReceipt(${receipt.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger me-1" onclick="deleteReceipt(${receipt.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="btn btn-sm btn-success" onclick="showPaymentReceipt(${receipt.id})">
                            <i class="fas fa-receipt"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // تحديث جدول تعبئة الشاحنات
        function updateTruckLoadingTable() {
            const tbody = document.getElementById('loadingTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            appData.truckLoadings.forEach(loading => {
                const truck = appData.trucks.find(t => t.id === loading.truckId);
                const truckName = truck ? truck.driverName : 'شاحنة محذوفة';
                const date = new Date(loading.createdAt).toLocaleDateString('ar-SA');
                const loadTypeText = loading.loadType === 'full' ? 'حمولة كاملة' : 'نصف حمولة';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${date}</td>
                    <td>${truckName}</td>
                    <td>${loading.loadCount}</td>
                    <td>${loadTypeText}</td>
                    <td>${loading.loadPrice.toFixed(2)} ريال</td>
                    <td>${loading.total.toFixed(2)} ريال</td>
                    <td>
                        <button class="btn btn-sm btn-primary me-1" onclick="editTruckLoading(${loading.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger me-1" onclick="deleteTruckLoading(${loading.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="btn btn-sm btn-success" onclick="showLoadingReceipt(${loading.id})">
                            <i class="fas fa-receipt"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // تحديث جدول المصروفات
        function updateExpensesTable() {
            const tbody = document.getElementById('expensesTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            let totalAmount = 0;
            
            appData.expenses.forEach((expense, index) => {
                const date = new Date(expense.createdAt).toLocaleDateString('ar-SA');
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${date}</td>
                    <td>${expense.type}</td>
                    <td class="expense-amount-cell">${expense.amount.toFixed(2)}</td>
                    <td>${expense.description}</td>
                    <td>
                        <div class="expense-actions">
                            <button class="btn btn-sm btn-primary" onclick="editExpense(${expense.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteExpense(${expense.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
                
                totalAmount += expense.amount;
            });
            
            document.getElementById('totalExpensesAmount').textContent = totalAmount.toFixed(2);
        }

        // تصفية المصروفات
        function filterExpenses() {
            const searchInput = document.getElementById('expenseSearchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#expensesTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchInput) ? '' : 'none';
            });
        }

        // تعديل مصروف
        function editExpense(id) {
            const expense = appData.expenses.find(e => e.id === id);
            if (!expense) return;
            
            document.getElementById('expenseId').value = expense.id;
            document.getElementById('expenseType').value = expense.type;
            document.getElementById('expenseAmount').value = expense.amount;
            document.getElementById('expenseDescription').value = expense.description;
            document.getElementById('saveExpenseBtn').innerHTML = '<i class="fas fa-save me-2"></i>تحديث المصروف';
            document.getElementById('cancelEditExpenseBtn').style.display = 'inline-block';
        }

        // حذف مصروف
        function deleteExpense(id) {
            if (confirm('هل أنت متأكد من حذف هذا المصروف؟')) {
                const index = appData.expenses.findIndex(e => e.id === id);
                if (index !== -1) {
                    const expense = appData.expenses[index];
                    
                    // نقل إلى سلة المحذوفات
                    appData.trash.push({
                        originalId: id,
                        type: 'expense',
                        data: expense,
                        deletedAt: new Date().toISOString()
                    });
                    
                    appData.expenses.splice(index, 1);
                    saveData();
                    updateExpensesTable();
                    showAlert('تم حذف المصروف', 'success');
                }
            }
        }

        // طباعة جدول المصروفات
        function printExpensesTable() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>طباعة جدول المصروفات</title>
                    <style>
                        body { font-family: Arial, sans-serif; direction: rtl; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
                        th { background-color: #f2f2f2; }
                        .total-row { font-weight: bold; background-color: #e9ecef; }
                    </style>
                </head>
                <body>
                    <h2 style="text-align: center;">جدول المصروفات</h2>
                    ${document.getElementById('expensesTable').outerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // تصدير جدول المصروفات كـ PDF
        function exportExpensesPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFont('helvetica');
            doc.setFontSize(16);
            doc.text('جدول المصروفات', 105, 20, { align: 'center' });
            
            doc.autoTable({
                html: '#expensesTable',
                startY: 30,
                styles: { 
                    font: 'helvetica', 
                    fontSize: 9, 
                    cellPadding: 3, 
                    halign: 'center' 
                },
                headStyles: { 
                    fillColor: [44, 90, 160], 
                    textColor: 255,
                    fontStyle: 'bold'
                }
            });
            
            doc.save('المصروفات.pdf');
        }

        // تحديث جدول ترميز الشاحنات
        function updateTruckEncodingTable() {
            const tbody = document.getElementById('truckEncodingTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            Object.keys(truckEncodingSettings).forEach(truckId => {
                const settings = truckEncodingSettings[truckId];
                const truck = appData.trucks.find(t => t.id == truckId);
                
                if (truck) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${truck.driverName}</td>
                        <td>${settings.fullLoadPrice} ريال</td>
                        <td>${settings.halfLoadPrice} ريال</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteTruckEncoding(${truckId})">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                }
            });
        }

        // حذف إعدادات الشاحنة
        function deleteTruckEncoding(truckId) {
            if (confirm('هل أنت متأكد من حذف إعدادات هذه الشاحنة؟')) {
                delete truckEncodingSettings[truckId];
                saveTruckEncodingSettings();
                updateTruckEncodingTable();
                showAlert('تم حذف إعدادات الشاحنة', 'success');
            }
        }

        // حفظ إعدادات ترميز الشاحنات
        function saveTruckEncodingSettingsForm(e) {
            e.preventDefault();
            
            const truckId = parseInt(document.getElementById('selectedTruck').value);
            const fullLoadPrice = parseFloat(document.getElementById('fullLoadPrice').value);
            const halfLoadPrice = parseFloat(document.getElementById('halfLoadPrice').value);
            
            if (!truckId) {
                showAlert('يرجى اختيار الشاحنة', 'warning');
                return;
            }
            
            truckEncodingSettings[truckId] = {
                fullLoadPrice: fullLoadPrice,
                halfLoadPrice: halfLoadPrice
            };
            
            saveTruckEncodingSettings();
            updateTruckEncodingTable();
            
            // إعادة تعيين النموذج
            document.getElementById('truckEncodingForm').reset();
            showAlert('تم حفظ إعدادات الشاحنة بنجاح', 'success');
        }

        // تحديث إحصائيات حسابات الشاحنات
        function updateTruckAccountsStats() {
            const totalTrucksCount = document.getElementById('totalTrucksCount');
            const totalTruckRevenue = document.getElementById('totalTruckRevenue');
            const totalTruckPayments = document.getElementById('totalTruckPayments');
            const totalTruckBalance = document.getElementById('totalTruckBalance');
            
            if (!totalTrucksCount || !totalTruckRevenue || !totalTruckPayments || !totalTruckBalance) return;
            
            totalTrucksCount.textContent = appData.trucks.length;
            
            const totalRevenue = appData.truckLoadings.reduce((sum, loading) => sum + loading.total, 0);
            totalTruckRevenue.textContent = totalRevenue.toFixed(2);
            
            const truckReceipts = appData.receipts.filter(receipt => receipt.recipientType === 'truck');
            const totalPayments = truckReceipts.reduce((sum, receipt) => sum + receipt.amount, 0);
            totalTruckPayments.textContent = totalPayments.toFixed(2);
            
            const totalBalance = appData.trucks.reduce((sum, truck) => sum + truck.balance, 0);
            totalTruckBalance.textContent = totalBalance.toFixed(2);
        }

        // تحديث قائمة حسابات الشاحنات
        function updateTruckAccountsList() {
            const container = document.getElementById('truckAccountsList');
            if (!container) return;
            
            container.innerHTML = '';
            
            appData.trucks.forEach(truck => {
                // حساب إجمالي الإيرادات من عمليات التعبئة
                const truckLoadings = appData.truckLoadings.filter(loading => loading.truckId === truck.id);
                const totalRevenue = truckLoadings.reduce((sum, loading) => sum + loading.total, 0);
                
                // حساب إجمالي المدفوعات من السندات
                const truckReceipts = appData.receipts.filter(receipt => receipt.recipientType === 'truck' && receipt.truckId === truck.id);
                const totalPayments = truckReceipts.reduce((sum, receipt) => sum + receipt.amount, 0);
                
                // حساب الرصيد الحالي
                const currentBalance = truck.balance;
                
                const balanceClass = currentBalance > 0 ? 'balance-positive' : 
                                   currentBalance < 0 ? 'balance-negative' : 'balance-zero';
                
                const cardHtml = `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card truck-accounts-card">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">${truck.driverName}</h6>
                                <small>${truck.truckNumber || 'غير محدد'}</small>
                            </div>
                            <div class="card-body">
                                <div class="account-balance ${balanceClass}">
                                    ${currentBalance.toFixed(2)} ريال
                                </div>
                                <div class="truck-account-details">
                                    <div class="d-flex justify-content-between">
                                        <span>الإيرادات:</span>
                                        <strong>${totalRevenue.toFixed(2)}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>المدفوعات:</span>
                                        <strong>${totalPayments.toFixed(2)}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>عدد عمليات التعبئة:</span>
                                        <strong>${truckLoadings.length}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                container.innerHTML += cardHtml;
            });
        }

        // البحث في حسابات الشاحنات
        function searchTruckAccounts() {
            const searchTerm = document.getElementById('truckAccountSearch').value.toLowerCase();
            const cards = document.querySelectorAll('#truckAccountsList .card');
            
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.parentElement.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }

        // تحديث جدول سلة المحذوفات
        function updateTrashTable() {
            const tbody = document.getElementById('trashTable');
            const emptyMessage = document.getElementById('emptyTrashMessage');
            
            if (!tbody || !emptyMessage) return;
            
            tbody.innerHTML = '';
            
            if (appData.trash.length === 0) {
                emptyMessage.style.display = 'block';
                return;
            }
            
            emptyMessage.style.display = 'none';
            
            appData.trash.forEach(item => {
                const date = new Date(item.deletedAt).toLocaleDateString('ar-SA');
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${getTrashItemTypeText(item.type)}</td>
                    <td>${getTrashItemDataText(item)}</td>
                    <td>${date}</td>
                    <td>
                        <button class="btn btn-sm btn-success me-1" onclick="restoreItem(${item.originalId}, '${item.type}')">
                            <i class="fas fa-undo"></i> استعادة
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="permanentDelete(${item.originalId}, '${item.type}')">
                            <i class="fas fa-trash-alt"></i> حذف نهائي
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // الحصول على نص نوع العنصر المحذوف
        function getTrashItemTypeText(type) {
            const types = {
                'customer': 'عميل',
                'truck': 'شاحنة',
                'irrigation': 'عملية ري',
                'receipt': 'سند قبض',
                'truckLoading': 'تعبئة شاحنة',
                'expense': 'مصروف'
            };
            return types[type] || type;
        }

        // الحصول على نص بيانات العنصر المحذوف
        function getTrashItemDataText(item) {
            switch(item.type) {
                case 'customer':
                    return `${item.data.name} - ${item.data.farmName}`;
                case 'truck':
                    return `${item.data.driverName} - ${item.data.truckNumber || 'غير محدد'}`;
                case 'irrigation':
                    const customer = appData.customers.find(c => c.id === item.data.customerId);
                    const timeDisplay = formatTimeForDisplay(item.data.hoursWorked, item.data.minutesWorked);
                    return `${customer ? customer.name : 'عميل محذوف'} - ${timeDisplay}`;
                case 'receipt':
                    if (item.data.recipientType === 'customer') {
                        const receiptCustomer = appData.customers.find(c => c.id === item.data.customerId);
                        return `${receiptCustomer ? receiptCustomer.name : 'عميل محذوف'} - ${item.data.amount} ريال`;
                    } else {
                        const receiptTruck = appData.trucks.find(t => t.id === item.data.truckId);
                        return `${receiptTruck ? receiptTruck.driverName : 'شاحنة محذوفة'} - ${item.data.amount} ريال`;
                    }
                case 'truckLoading':
                    const truck = appData.trucks.find(t => t.id === item.data.truckId);
                    return `${truck ? truck.driverName : 'شاحنة محذوفة'} - ${item.data.loadCount} حملة`;
                case 'expense':
                    return `${item.data.type} - ${item.data.amount} ريال`;
                default:
                    return 'بيانات غير معروفة';
            }
        }

        // البحث في العملاء
        function searchCustomers() {
            const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#customersTable tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // البحث في الشاحنات
        function searchTrucks() {
            const searchTerm = document.getElementById('truckSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#trucksTable tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // البحث في عمليات الري
        function searchIrrigations() {
            const searchTerm = document.getElementById('irrigationSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#irrigationTable tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // البحث في سندات القبض
        function searchReceipts() {
            const searchTerm = document.getElementById('receiptSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#receiptTable tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // البحث في عمليات التعبئة
        function searchLoadings() {
            const searchTerm = document.getElementById('loadingSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#loadingTable tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // تعديل عميل
        function editCustomer(id) {
            const customer = appData.customers.find(c => c.id === id);
            if (!customer) return;
            
            currentEditId = id;
            currentEditType = 'customer';
            
            document.getElementById('editModalTitle').textContent = 'تعديل بيانات العميل';
            document.getElementById('editModalBody').innerHTML = `
                <div class="mb-3">
                    <label for="editCustomerName" class="form-label">اسم العميل</label>
                    <input type="text" class="form-control" id="editCustomerName" value="${customer.name}" required>
                </div>
                <div class="mb-3">
                    <label for="editCustomerPhone" class="form-label">رقم الهاتف</label>
                    <input type="tel" class="form-control" id="editCustomerPhone" value="${customer.phone}" required>
                </div>
                <div class="mb-3">
                    <label for="editFarmName" class="form-label">اسم الجرة (المزرعة)</label>
                    <input type="text" class="form-control" id="editFarmName" value="${customer.farmName}" required>
                </div>
            `;
            
            new bootstrap.Modal(document.getElementById('editModal')).show();
        }

        // تعديل شاحنة
        function editTruck(id) {
            const truck = appData.trucks.find(t => t.id === id);
            if (!truck) return;
            
            currentEditId = id;
            currentEditType = 'truck';
            
            document.getElementById('editModalTitle').textContent = 'تعديل بيانات الشاحنة';
            document.getElementById('editModalBody').innerHTML = `
                <div class="mb-3">
                    <label for="editDriverName" class="form-label">اسم السائق/المالك</label>
                    <input type="text" class="form-control" id="editDriverName" value="${truck.driverName}" required>
                </div>
                <div class="mb-3">
                    <label for="editDriverPhone" class="form-label">رقم الهاتف</label>
                    <input type="tel" class="form-control" id="editDriverPhone" value="${truck.phone}" required>
                </div>
                <div class="mb-3">
                    <label for="editTruckNumber" class="form-label">رقم الشاحنة</label>
                    <input type="text" class="form-control" id="editTruckNumber" value="${truck.truckNumber || ''}">
                </div>
            `;
            
            new bootstrap.Modal(document.getElementById('editModal')).show();
        }

        // تعديل عملية ري
        function editIrrigation(id) {
            const irrigation = appData.irrigations.find(i => i.id === id);
            if (!irrigation) return;
            
            currentEditId = id;
            currentEditType = 'irrigation';
            
            document.getElementById('editModalTitle').textContent = 'تعديل بيانات عملية الري';
            document.getElementById('editModalBody').innerHTML = `
                <div class="mb-3">
                    <label for="editIrrigationCustomer" class="form-label">اختيار العميل</label>
                    <select class="form-select" id="editIrrigationCustomer" required>
                        <option value="">اختر العميل...</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="editFuelBrought" class="form-label">كمية الديزل المجلوبة (لتر)</label>
                    <input type="number" class="form-control" id="editFuelBrought" step="0.1" value="${irrigation.fuelBrought}" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">مدة الري</label>
                    <div class="time-input-container">
                        <span class="time-label">ساعات:</span>
                        <input type="number" class="form-control" id="editHoursWorked" min="0" max="24" value="${irrigation.hoursWorked}" required>
                        <span class="time-label">دقائق:</span>
                        <input type="number" class="form-control" id="editMinutesWorked" min="0" max="59" value="${irrigation.minutesWorked}" required>
                    </div>
                </div>
            `;
            
            // ملء قائمة العملاء
            const select = document.getElementById('editIrrigationCustomer');
            appData.customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = `${customer.name} - ${customer.farmName}`;
                if (customer.id === irrigation.customerId) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
            
            new bootstrap.Modal(document.getElementById('editModal')).show();
        }

        // تعديل عملية تعبئة
        function editTruckLoading(id) {
            const loading = appData.truckLoadings.find(l => l.id === id);
            if (!loading) return;
            
            currentEditId = id;
            currentEditType = 'truckLoading';
            
            document.getElementById('editModalTitle').textContent = 'تعديل بيانات التعبئة';
            document.getElementById('editModalBody').innerHTML = `
                <div class="mb-3">
                    <label for="editLoadingTruck" class="form-label">اختيار الشاحنة</label>
                    <select class="form-select" id="editLoadingTruck" required>
                        <option value="">اختر الشاحنة...</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="editLoadCount" class="form-label">عدد الحملات</label>
                    <input type="number" class="form-control" id="editLoadCount" value="${loading.loadCount}" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">نوع الحمولة</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="editLoadType" id="editFullLoad" value="full" ${loading.loadType === 'full' ? 'checked' : ''}>
                        <label class="btn btn-outline-primary" for="editFullLoad">حمولة كاملة</label>
                        <input type="radio" class="btn-check" name="editLoadType" id="editHalfLoad" value="half" ${loading.loadType === 'half' ? 'checked' : ''}>
                        <label class="btn btn-outline-primary" for="editHalfLoad">نصف حمولة</label>
                    </div>
                </div>
            `;
            
            // ملء قائمة الشاحنات
            const select = document.getElementById('editLoadingTruck');
            appData.trucks.forEach(truck => {
                const option = document.createElement('option');
                option.value = truck.id;
                option.textContent = `${truck.driverName} - ${truck.truckNumber || 'غير محدد'}`;
                if (truck.id === loading.truckId) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
            
            new bootstrap.Modal(document.getElementById('editModal')).show();
        }

        // تعديل سند قبض
        function editReceipt(id) {
            const receipt = appData.receipts.find(r => r.id === id);
            if (!receipt) return;
            
            currentEditId = id;
            currentEditType = 'receipt';
            
            document.getElementById('editModalTitle').textContent = 'تعديل سند القبض';
            document.getElementById('editModalBody').innerHTML = `
                <div class="mb-3">
                    <label for="editPaymentAmount" class="form-label">مبلغ السداد</label>
                    <input type="number" class="form-control" id="editPaymentAmount" value="${receipt.amount}" step="0.01" required>
                </div>
            `;
            
            new bootstrap.Modal(document.getElementById('editModal')).show();
        }

        // حفظ التعديل
        function saveEdit() {
            if (!currentEditId || !currentEditType) return;
            
            try {
                switch(currentEditType) {
                    case 'customer':
                        const customer = appData.customers.find(c => c.id === currentEditId);
                        if (customer) {
                            customer.name = document.getElementById('editCustomerName').value;
                            customer.phone = document.getElementById('editCustomerPhone').value;
                            customer.farmName = document.getElementById('editFarmName').value;
                            updateCustomersTable();
                            updateCustomerSelects();
                        }
                        break;
                        
                    case 'truck':
                        const truck = appData.trucks.find(t => t.id === currentEditId);
                        if (truck) {
                            truck.driverName = document.getElementById('editDriverName').value;
                            truck.phone = document.getElementById('editDriverPhone').value;
                            truck.truckNumber = document.getElementById('editTruckNumber').value;
                            updateTrucksTable();
                            updateTruckSelects();
                            updateTruckEncodingSelects();
                            updateTruckSelectsForReceipts();
                            updateReportTruckSelect();
                        }
                        break;
                        
                    case 'irrigation':
                        const irrigation = appData.irrigations.find(i => i.id === currentEditId);
                        if (irrigation) {
                            const oldCustomerId = irrigation.customerId;
                            const oldTotalCost = irrigation.totalCost;
                            
                            irrigation.customerId = parseInt(document.getElementById('editIrrigationCustomer').value);
                            irrigation.fuelBrought = parseFloat(document.getElementById('editFuelBrought').value);
                            irrigation.hoursWorked = parseFloat(document.getElementById('editHoursWorked').value);
                            irrigation.minutesWorked = parseFloat(document.getElementById('editMinutesWorked').value);
                            
                            // إعادة حساب القيم
                            irrigation.totalHours = irrigation.hoursWorked + (irrigation.minutesWorked / 60);
                            irrigation.fuelConsumed = irrigation.totalHours * appData.settings.fuelConsumptionRate;
                            irrigation.totalCost = irrigation.totalHours * appData.settings.hourlyRate;
                            irrigation.remainingFuel = irrigation.fuelBrought - irrigation.fuelConsumed;
                            
                            // تحديث أرصدة العملاء
                            if (oldCustomerId !== irrigation.customerId) {
                                const oldCustomer = appData.customers.find(c => c.id === oldCustomerId);
                                if (oldCustomer) {
                                    oldCustomer.balance -= oldTotalCost;
                                }
                                
                                const newCustomer = appData.customers.find(c => c.id === irrigation.customerId);
                                if (newCustomer) {
                                    newCustomer.balance += irrigation.totalCost;
                                }
                            } else {
                                const customer = appData.customers.find(c => c.id === irrigation.customerId);
                                if (customer) {
                                    customer.balance = customer.balance - oldTotalCost + irrigation.totalCost;
                                }
                            }
                            
                            updateIrrigationTable();
                            updateCustomersTable();
                        }
                        break;
                        
                    case 'truckLoading':
                        const loading = appData.truckLoadings.find(l => l.id === currentEditId);
                        if (loading) {
                            const oldTruckId = loading.truckId;
                            const oldTotal = loading.total;
                            
                            loading.truckId = parseInt(document.getElementById('editLoadingTruck').value);
                            loading.loadCount = parseInt(document.getElementById('editLoadCount').value);
                            loading.loadType = document.querySelector('input[name="editLoadType"]:checked').value;
                            
                            // إعادة الحساب
                            const settings = truckEncodingSettings[loading.truckId];
                            if (settings) {
                                loading.loadPrice = loading.loadType === 'full' ? settings.fullLoadPrice : settings.halfLoadPrice;
                                loading.total = loading.loadCount * loading.loadPrice;
                            }
                            
                            // تحديث أرصدة الشاحنات
                            if (oldTruckId !== loading.truckId) {
                                const oldTruck = appData.trucks.find(t => t.id === oldTruckId);
                                if (oldTruck) {
                                    oldTruck.balance -= oldTotal;
                                }
                                
                                const newTruck = appData.trucks.find(t => t.id === loading.truckId);
                                if (newTruck) {
                                    newTruck.balance += loading.total;
                                }
                            } else {
                                const truck = appData.trucks.find(t => t.id === loading.truckId);
                                if (truck) {
                                    truck.balance = truck.balance - oldTotal + loading.total;
                                }
                            }
                            
                            updateTruckLoadingTable();
                            updateTrucksTable();
                        }
                        break;
                        
                    case 'receipt':
                        const receipt = appData.receipts.find(r => r.id === currentEditId);
                        if (receipt) {
                            const oldAmount = receipt.amount;
                            receipt.amount = parseFloat(document.getElementById('editPaymentAmount').value);
                            
                            // تحديث الرصيد حسب النوع
                            if (receipt.recipientType === 'customer') {
                                const customer = appData.customers.find(c => c.id === receipt.customerId);
                                if (customer) {
                                    customer.balance = customer.balance + oldAmount - receipt.amount;
                                }
                            } else {
                                const truck = appData.trucks.find(t => t.id === receipt.truckId);
                                if (truck) {
                                    truck.balance = truck.balance + oldAmount - receipt.amount;
                                }
                            }
                            
                            updateReceiptTable();
                            updateCustomersTable();
                            updateTrucksTable();
                        }
                        break;
                }
                
                saveData();
                bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                showAlert('تم حفظ التغييرات بنجاح', 'success');
                
            } catch (error) {
                console.error('Error in saveEdit:', error);
                showAlert('حدث خطأ أثناء حفظ التغييرات', 'danger');
            }
            
            currentEditId = null;
            currentEditType = null;
        }

        // حذف عميل
        function deleteCustomer(id) {
            if (confirm('هل أنت متأكد من حذف هذا العميل؟')) {
                const customerIndex = appData.customers.findIndex(c => c.id === id);
                if (customerIndex !== -1) {
                    const customer = appData.customers[customerIndex];
                    
                    // نقل إلى سلة المحذوفات
                    appData.trash.push({
                        originalId: id,
                        type: 'customer',
                        data: customer,
                        deletedAt: new Date().toISOString()
                    });
                    
                    // حذف من القائمة الأصلية
                    appData.customers.splice(customerIndex, 1);
                    
                    saveData();
                    updateCustomersTable();
                    updateCustomerSelects();
                    showAlert('تم حذف العميل ونقله إلى سلة المحذوفات', 'warning');
                }
            }
        }

        // حذف شاحنة
        function deleteTruck(id) {
            if (confirm('هل أنت متأكد من حذف هذه الشاحنة؟')) {
                const truckIndex = appData.trucks.findIndex(t => t.id === id);
                if (truckIndex !== -1) {
                    const truck = appData.trucks[truckIndex];
                    
                    // نقل إلى سلة المحذوفات
                    appData.trash.push({
                        originalId: id,
                        type: 'truck',
                        data: truck,
                        deletedAt: new Date().toISOString()
                    });
                    
                    // حذف من القائمة الأصلية
                    appData.trucks.splice(truckIndex, 1);
                    
                    saveData();
                    updateTrucksTable();
                    updateTruckSelects();
                    updateTruckEncodingSelects();
                    updateTruckSelectsForReceipts();
                    updateReportTruckSelect();
                    showAlert('تم حذف الشاحنة ونقلها إلى سلة المحذوفات', 'warning');
                }
            }
        }

        // حذف عملية ري
        function deleteIrrigation(id) {
            if (confirm('هل أنت متأكد من حذف عملية الري هذه؟')) {
                const irrigationIndex = appData.irrigations.findIndex(i => i.id === id);
                if (irrigationIndex !== -1) {
                    const irrigation = appData.irrigations[irrigationIndex];
                    
                    // تحديث رصيد العميل
                    const customer = appData.customers.find(c => c.id === irrigation.customerId);
                    if (customer) {
                        customer.balance -= irrigation.totalCost;
                    }
                    
                    // نقل إلى سلة المحذوفات
                    appData.trash.push({
                        originalId: id,
                        type: 'irrigation',
                        data: irrigation,
                        deletedAt: new Date().toISOString()
                    });
                    
                    // حذف من القائمة الأصلية
                    appData.irrigations.splice(irrigationIndex, 1);
                    
                    saveData();
                    updateIrrigationTable();
                    updateCustomersTable();
                    showAlert('تم حذف عملية الري ونقلها إلى سلة المحذوفات', 'warning');
                }
            }
        }

        // حذف سند قبض
        function deleteReceipt(id) {
            if (confirm('هل أنت متأكد من حذف سند القبض هذا؟')) {
                const receiptIndex = appData.receipts.findIndex(r => r.id === id);
                if (receiptIndex !== -1) {
                    const receipt = appData.receipts[receiptIndex];
                    
                    // تحديث الرصيد حسب النوع
                    if (receipt.recipientType === 'customer') {
                        const customer = appData.customers.find(c => c.id === receipt.customerId);
                        if (customer) {
                            customer.balance += receipt.amount;
                        }
                    } else {
                        const truck = appData.trucks.find(t => t.id === receipt.truckId);
                        if (truck) {
                            truck.balance += receipt.amount;
                        }
                    }
                    
                    // نقل إلى سلة المحذوفات
                    appData.trash.push({
                        originalId: id,
                        type: 'receipt',
                        data: receipt,
                        deletedAt: new Date().toISOString()
                    });
                    
                    // حذف من القائمة الأصلية
                    appData.receipts.splice(receiptIndex, 1);
                    
                    saveData();
                    updateReceiptTable();
                    updateCustomersTable();
                    updateTrucksTable();
                    showAlert('تم حذف سند القبض ونقله إلى سلة المحذوفات', 'warning');
                }
            }
        }

        // حذف عملية تعبئة شاحنة
        function deleteTruckLoading(id) {
            if (confirm('هل أنت متأكد من حذف عملية التعبئة هذه؟')) {
                const loadingIndex = appData.truckLoadings.findIndex(l => l.id === id);
                if (loadingIndex !== -1) {
                    const loading = appData.truckLoadings[loadingIndex];
                    
                    // تحديث رصيد الشاحنة
                    const truck = appData.trucks.find(t => t.id === loading.truckId);
                    if (truck) {
                        truck.balance -= loading.total;
                    }
                    
                    // نقل إلى سلة المحذوفات
                    appData.trash.push({
                        originalId: id,
                        type: 'truckLoading',
                        data: loading,
                        deletedAt: new Date().toISOString()
                    });
                    
                    // حذف من القائمة الأصلية
                    appData.truckLoadings.splice(loadingIndex, 1);
                    
                    saveData();
                    updateTruckLoadingTable();
                    updateTrucksTable();
                    showAlert('تم حذف عملية التعبئة ونقلها إلى سلة المحذوفات', 'warning');
                }
            }
        }

        // استعادة عنصر من سلة المحذوفات
        function restoreItem(originalId, type) {
            const trashIndex = appData.trash.findIndex(item => item.originalId === originalId && item.type === type);
            if (trashIndex !== -1) {
                const trashItem = appData.trash[trashIndex];
                
                switch(type) {
                    case 'customer':
                        appData.customers.push(trashItem.data);
                        updateCustomersTable();
                        updateCustomerSelects();
                        break;
                    case 'truck':
                        appData.trucks.push(trashItem.data);
                        updateTrucksTable();
                        updateTruckSelects();
                        updateTruckEncodingSelects();
                        updateTruckSelectsForReceipts();
                        updateReportTruckSelect();
                        break;
                    case 'irrigation':
                        appData.irrigations.push(trashItem.data);
                        // استعادة رصيد العميل
                        const customer = appData.customers.find(c => c.id === trashItem.data.customerId);
                        if (customer) {
                            customer.balance += trashItem.data.totalCost;
                        }
                        updateIrrigationTable();
                        updateCustomersTable();
                        break;
                    case 'receipt':
                        appData.receipts.push(trashItem.data);
                        // استعادة رصيد حسب النوع
                        if (trashItem.data.recipientType === 'customer') {
                            const receiptCustomer = appData.customers.find(c => c.id === trashItem.data.customerId);
                            if (receiptCustomer) {
                                receiptCustomer.balance -= trashItem.data.amount;
                            }
                        } else {
                            const receiptTruck = appData.trucks.find(t => t.id === trashItem.data.truckId);
                            if (receiptTruck) {
                                receiptTruck.balance -= trashItem.data.amount;
                            }
                        }
                        updateReceiptTable();
                        updateCustomersTable();
                        updateTrucksTable();
                        break;
                    case 'truckLoading':
                        appData.truckLoadings.push(trashItem.data);
                        // استعادة رصيد الشاحنة
                        const truck = appData.trucks.find(t => t.id === trashItem.data.truckId);
                        if (truck) {
                            truck.balance += trashItem.data.total;
                        }
                        updateTruckLoadingTable();
                        updateTrucksTable();
                        break;
                    case 'expense':
                        appData.expenses.push(trashItem.data);
                        updateExpensesTable();
                        break;
                }
                
                // حذف من سلة المحذوفات
                appData.trash.splice(trashIndex, 1);
                
                saveData();
                updateTrashTable();
                showAlert('تم استعادة العنصر بنجاح', 'success');
            }
        }

        // حذف نهائي
        function permanentDelete(originalId, type) {
            if (confirm('هل أنت متأكد من الحذف النهائي؟ لن يمكن استعادة هذا العنصر.')) {
                const trashIndex = appData.trash.findIndex(item => item.originalId === originalId && item.type === type);
                if (trashIndex !== -1) {
                    appData.trash.splice(trashIndex, 1);
                    saveData();
                    updateTrashTable();
                    showAlert('تم الحذف النهائي', 'danger');
                }
            }
        }

        // تفريغ سلة المحذوفات
        function emptyTrash() {
            if (confirm('هل أنت متأكد من تفريغ سلة المحذوفات؟ سيتم حذف جميع العناصر نهائياً.')) {
                appData.trash = [];
                saveData();
                updateTrashTable();
                showAlert('تم تفريغ سلة المحذوفات', 'warning');
            }
        }

        // اتصال بالعميل
        function callCustomer(phone) {
            window.open(`tel:${phone}`);
        }

        // إرسال رسالة للعميل
        function messageCustomer(phone) {
            window.open(`sms:${phone}`);
        }

        // عرض إيصال عملية الري
        function showIrrigationReceipt(id) {
            const irrigation = appData.irrigations.find(i => i.id === id);
            if (!irrigation) return;
            
            const customer = appData.customers.find(c => c.id === irrigation.customerId);
            const customerName = customer ? customer.name : 'عميل محذوف';
            const date = new Date(irrigation.createdAt).toLocaleDateString('ar-SA');
            const timeDisplay = formatTimeForDisplay(irrigation.hoursWorked, irrigation.minutesWorked);
            
            const receiptHtml = `
                <div class="receipt-container">
                    <div class="receipt-header">
                        <h3>${appData.settings.appName}</h3>
                        <h4>إيصال عملية ري</h4>
                    </div>
                    <div class="receipt-details">
                        <table>
                            <tr><td><strong>التاريخ:</strong></td><td>${date}</td></tr>
                            <tr><td><strong>العميل:</strong></td><td>${customerName}</td></tr>
                            <tr><td><strong>مدة الري:</strong></td><td>${timeDisplay}</td></tr>
                            <tr><td><strong>الديزل المجلوب:</strong></td><td>${irrigation.fuelBrought} لتر</td></tr>
                            <tr><td><strong>الديزل المستهلك:</strong></td><td>${irrigation.fuelConsumed.toFixed(1)} لتر</td></tr>
                            <tr><td><strong>المتبقي من الديزل:</strong></td><td>${irrigation.remainingFuel.toFixed(1)} لتر</td></tr>
                        </table>
                    </div>
                    <div class="receipt-total">
                        المبلغ الإجمالي: ${irrigation.totalCost.toFixed(2)} ريال
                    </div>
                </div>
            `;
            
            document.getElementById('receiptModalBody').innerHTML = receiptHtml;
            new bootstrap.Modal(document.getElementById('receiptModal')).show();
        }

        // عرض إيصال تعبئة الشاحنة
        function showLoadingReceipt(id) {
            const loading = appData.truckLoadings.find(l => l.id === id);
            if (!loading) return;
            
            const truck = appData.trucks.find(t => t.id === loading.truckId);
            const truckName = truck ? truck.driverName : 'شاحنة محذوفة';
            const date = new Date(loading.createdAt).toLocaleDateString('ar-SA');
            const loadTypeText = loading.loadType === 'full' ? 'حمولة كاملة' : 'نصف حمولة';
            
            const receiptHtml = `
                <div class="receipt-container">
                    <div class="receipt-header">
                        <h3>${appData.settings.appName}</h3>
                        <h4>إيصال تعبئة شاحنة</h4>
                    </div>
                    <div class="receipt-details">
                        <table>
                            <tr><td><strong>التاريخ:</strong></td><td>${date}</td></tr>
                            <tr><td><strong>الشاحنة:</strong></td><td>${truckName}</td></tr>
                            <tr><td><strong>عدد الحملات:</strong></td><td>${loading.loadCount}</td></tr>
                            <tr><td><strong>نوع الحمولة:</strong></td><td>${loadTypeText}</td></tr>
                            <tr><td><strong>سعر الحملة:</strong></td><td>${loading.loadPrice.toFixed(2)} ريال</td></tr>
                        </table>
                    </div>
                    <div class="receipt-total">
                        المبلغ الإجمالي: ${loading.total.toFixed(2)} ريال
                    </div>
                </div>
            `;
            
            document.getElementById('receiptModalBody').innerHTML = receiptHtml;
            new bootstrap.Modal(document.getElementById('receiptModal')).show();
        }

        // عرض إيصال سند القبض
        function showPaymentReceipt(id) {
            const receipt = appData.receipts.find(r => r.id === id);
            if (!receipt) return;
            
            let recipientName = '';
            let recipientType = '';
            
            if (receipt.recipientType === 'customer') {
                const customer = appData.customers.find(c => c.id === receipt.customerId);
                recipientName = customer ? customer.name : 'عميل محذوف';
                recipientType = 'عميل';
            } else {
                const truck = appData.trucks.find(t => t.id === receipt.truckId);
                recipientName = truck ? truck.driverName : 'شاحنة محذوفة';
                recipientType = 'شاحنة';
            }
            
            const date = new Date(receipt.createdAt).toLocaleDateString('ar-SA');
            
            const receiptHtml = `
                <div class="receipt-container">
                    <div class="receipt-header">
                        <h3>${appData.settings.appName}</h3>
                        <h4>سند قبض</h4>
                    </div>
                    <div class="receipt-details">
                        <table>
                            <tr><td><strong>رقم السند:</strong></td><td>${receipt.receiptNumber}</td></tr>
                            <tr><td><strong>التاريخ:</strong></td><td>${date}</td></tr>
                            <tr><td><strong>نوع المستلم:</strong></td><td>${recipientType}</td></tr>
                            <tr><td><strong>اسم المستلم:</strong></td><td>${recipientName}</td></tr>
                        </table>
                    </div>
                    <div class="receipt-total">
                        المبلغ المدفوع: ${receipt.amount.toFixed(2)} ريال
                    </div>
                </div>
            `;
            
            document.getElementById('receiptModalBody').innerHTML = receiptHtml;
            new bootstrap.Modal(document.getElementById('receiptModal')).show();
        }

        // طباعة الإيصال
        function printReceipt() {
            const printContent = document.getElementById('receiptModalBody').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>طباعة إيصال</title>
                    <style>
                        body { font-family: Arial, sans-serif; direction: rtl; }
                        .receipt-container { max-width: 600px; margin: 0 auto; }
                        .receipt-header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
                        .receipt-details table { width: 100%; border-collapse: collapse; }
                        .receipt-details td { padding: 10px; border-bottom: 1px solid #eee; }
                        .receipt-total { background: #333; color: white; font-weight: bold; text-align: center; padding: 15px; margin-top: 20px; }
                    </style>
                </head>
                <body>
                    ${printContent}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // تصدير الإيصال كـ PDF
        function exportReceiptPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // إعداد الخط العربي (تقريبي)
            doc.setFont('helvetica');
            doc.setFontSize(16);
            
            const receiptContent = document.getElementById('receiptModalBody').textContent;
            const lines = receiptContent.split('\n').filter(line => line.trim());
            
            let y = 30;
            lines.forEach(line => {
                if (line.trim()) {
                    doc.text(line.trim(), 20, y);
                    y += 10;
                }
            });
            
            doc.save('receipt.pdf');
        }

        // تحديث إحصائيات التقارير
        function updateReportsStats() {
            const totalCustomers = document.getElementById('totalCustomers');
            const totalIrrigations = document.getElementById('totalIrrigations');
            const totalTrucks = document.getElementById('totalTrucks');
            const totalRevenue = document.getElementById('totalRevenue');
            
            if (!totalCustomers || !totalIrrigations || !totalTrucks || !totalRevenue) return;
            
            totalCustomers.textContent = appData.customers.length;
            totalIrrigations.textContent = appData.irrigations.length;
            totalTrucks.textContent = appData.trucks.length;
            
            const totalRevenueValue = appData.irrigations.reduce((sum, irrigation) => sum + irrigation.totalCost, 0) +
                                appData.truckLoadings.reduce((sum, loading) => sum + loading.total, 0);
            totalRevenue.textContent = totalRevenueValue.toFixed(2);
        }

        // تحديث قائمة العملاء في التقارير
        function updateReportCustomerSelect() {
            const select = document.getElementById('reportCustomer');
            if (!select) return;
            
            const currentValue = select.value;
            
            // مسح الخيارات الحالية (عدا الخيار الأول)
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            // إضافة العملاء
            appData.customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = `${customer.name} - ${customer.farmName}`;
                select.appendChild(option);
            });
            
            // استعادة القيمة المحددة
            select.value = currentValue;
        }

        // إنشاء التقرير
        function generateReport() {
            const period = document.getElementById('reportPeriod').value;
            const customerId = document.getElementById('reportCustomer').value;
            const truckId = document.getElementById('reportTruck').value;
            const reportType = document.getElementById('reportType').value;
            
            let reportData = [];
            let reportHtml = '';
            
            // فلترة البيانات حسب الفترة والعميل والشاحنة
            const now = new Date();
            let startDate = new Date();
            
            switch(period) {
                case 'daily':
                    startDate.setDate(now.getDate() - 1);
                    break;
                case 'weekly':
                    startDate.setDate(now.getDate() - 7);
                    break;
                case 'monthly':
                    startDate.setMonth(now.getMonth() - 1);
                    break;
                case 'yearly':
                    startDate.setFullYear(now.getFullYear() - 1);
                    break;
            }
            
            // إنشاء التقرير حسب النوع
            switch(reportType) {
                case 'irrigation':
                    reportData = appData.irrigations.filter(irrigation => {
                        const irrigationDate = new Date(irrigation.createdAt);
                        const matchesDate = irrigationDate >= startDate;
                        const matchesCustomer = !customerId || irrigation.customerId == customerId;
                        return matchesDate && matchesCustomer;
                    });
                    
                    reportHtml = generateIrrigationReport(reportData);
                    break;
                    
                case 'payments':
                    reportData = appData.receipts.filter(receipt => {
                        const receiptDate = new Date(receipt.createdAt);
                        const matchesDate = receiptDate >= startDate;
                        const matchesCustomer = !customerId || receipt.customerId == customerId;
                        const matchesTruck = !truckId || receipt.truckId == truckId;
                        return matchesDate && matchesCustomer && matchesTruck;
                    });
                    
                    reportHtml = generatePaymentReport(reportData);
                    break;
                    
                case 'trucks':
                    reportData = appData.truckLoadings.filter(loading => {
                        const loadingDate = new Date(loading.createdAt);
                        const matchesDate = loadingDate >= startDate;
                        const matchesTruck = !truckId || loading.truckId == truckId;
                        return matchesDate && matchesTruck;
                    });
                    
                    reportHtml = generateTruckReport(reportData);
                    break;
                    
                case 'truckAccounts':
                    reportHtml = generateTruckAccountsReport(startDate, truckId);
                    break;
                    
                case 'summary':
                    reportHtml = generateSummaryReport(startDate, customerId, truckId);
                    break;
            }
            
            document.getElementById('reportResults').innerHTML = reportHtml;
        }

        // إنشاء تقرير عمليات الري
        function generateIrrigationReport(data) {
            if (data.length === 0) {
                return '<div class="text-center text-muted"><p>لا توجد عمليات ري في الفترة المحددة</p></div>';
            }
            
            let html = '<h5 class="text-primary mb-3">📊 تقرير عمليات الري</h5>';
            html += '<div class="table-responsive">';
            html += '<table class="table table-striped table-hover">';
            html += '<thead class="table-primary"><tr>';
            html += '<th>📅 التاريخ</th>';
            html += '<th>👤 العميل</th>';
            html += '<th>⏱️ مدة الري</th>';
            html += '<th>⛽ الديزل المستهلك</th>';
            html += '<th>💰 القيمة</th>';
            html += '</tr></thead>';
            html += '<tbody>';
            
            let totalHours = 0;
            let totalFuel = 0;
            let totalCost = 0;
            
            data.forEach(irrigation => {
                const customer = appData.customers.find(c => c.id === irrigation.customerId);
                const customerName = customer ? customer.name : '🔴 عميل محذوف';
                const date = new Date(irrigation.createdAt).toLocaleDateString('ar-SA', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                const timeDisplay = formatTimeForDisplay(irrigation.hoursWorked, irrigation.minutesWorked);
                
                html += `<tr>
                    <td>${date}</td>
                    <td>${customerName}</td>
                    <td><span class="badge bg-info">${timeDisplay}</span></td>
                    <td><span class="badge bg-warning">${irrigation.fuelConsumed.toFixed(1)} لتر</span></td>
                    <td><strong class="text-success">${irrigation.totalCost.toFixed(2)} ريال</strong></td>
                </tr>`;
                
                totalHours += irrigation.totalHours;
                totalFuel += irrigation.fuelConsumed;
                totalCost += irrigation.totalCost;
            });
            
            html += '</tbody></table></div>';
            
            // إضافة الإحصائيات بطريقة جذابة
            html += `<div class="row mt-4">
                <div class="col-md-4">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h4>${formatHoursToDisplay(totalHours)}</h4>
                            <p>⏱️ إجمالي الوقت</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-warning text-dark">
                        <div class="card-body text-center">
                            <h4>${totalFuel.toFixed(1)}</h4>
                            <p>⛽ إجمالي الديزل (لتر)</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h4>${totalCost.toFixed(2)}</h4>
                            <p>💰 إجمالي القيمة (ريال)</p>
                        </div>
                    </div>
                </div>
            </div>`;
            
            return html;
        }

        // دالة مساعدة لتنسيق الساعات للعرض
        function formatHoursToDisplay(totalHours) {
            const hours = Math.floor(totalHours);
            const minutes = Math.round((totalHours - hours) * 60);
            
            return formatTimeForDisplay(hours, minutes);
        }

        // إنشاء تقرير المدفوعات
        function generatePaymentReport(data) {
            if (data.length === 0) {
                return '<div class="text-center text-muted"><p>لا توجد مدفوعات في الفترة المحددة</p></div>';
            }
            
            let html = '<h5 class="text-success mb-3">💵 تقرير المدفوعات</h5>';
            html += '<div class="table-responsive">';
            html += '<table class="table table-striped table-hover">';
            html += '<thead class="table-success"><tr>';
            html += '<th>🔢 رقم السند</th>';
            html += '<th>📅 التاريخ</th>';
            html += '<th>👤 النوع</th>';
            html += '<th>🚛/👤 المستلم</th>';
            html += '<th>💰 المبلغ</th>';
            html += '</tr></thead>';
            html += '<tbody>';
            
            let totalAmount = 0;
            let customerPayments = 0;
            let truckPayments = 0;
            
            data.forEach(receipt => {
                let recipientName = '';
                let typeText = '';
                
                if (receipt.recipientType === 'customer') {
                    const customer = appData.customers.find(c => c.id === receipt.customerId);
                    recipientName = customer ? customer.name : '🔴 عميل محذوف';
                    typeText = '👤 عميل';
                    customerPayments += receipt.amount;
                } else {
                    const truck = appData.trucks.find(t => t.id === receipt.truckId);
                    recipientName = truck ? truck.driverName : '🔴 شاحنة محذوفة';
                    typeText = '🚛 شاحنة';
                    truckPayments += receipt.amount;
                }
                
                const date = new Date(receipt.createdAt).toLocaleDateString('ar-SA', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                html += `<tr>
                    <td><span class="badge bg-secondary">${receipt.receiptNumber}</span></td>
                    <td>${date}</td>
                    <td>${typeText}</td>
                    <td>${recipientName}</td>
                    <td><strong class="text-success">${receipt.amount.toFixed(2)} ريال</strong></td>
                </tr>`;
                
                totalAmount += receipt.amount;
            });
            
            html += '</tbody></table></div>';
            
            // إضافة الإحصائيات
            html += `<div class="row mt-4">
                <div class="col-md-4">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h4>${totalAmount.toFixed(2)}</h4>
                            <p>💰 الإجمالي</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h4>${customerPayments.toFixed(2)}</h4>
                            <p>👤 مدفوعات العملاء</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-warning text-dark">
                        <div class="card-body text-center">
                            <h4>${truckPayments.toFixed(2)}</h4>
                            <p>🚛 مدفوعات الشاحنات</p>
                        </div>
                    </div>
                </div>
            </div>`;
            
            return html;
        }

        // إنشاء تقرير الشاحنات
        function generateTruckReport(data) {
            if (data.length === 0) {
                return '<div class="text-center text-muted"><p>لا توجد عمليات تعبئة في الفترة المحددة</p></div>';
            }
            
            let html = '<h5 class="text-warning mb-3">🚛 تقرير الشاحنات</h5>';
            html += '<div class="table-responsive">';
            html += '<table class="table table-striped table-hover">';
            html += '<thead class="table-warning"><tr>';
            html += '<th>📅 التاريخ</th>';
            html += '<th>🚛 الشاحنة</th>';
            html += '<th>📦 عدد الحملات</th>';
            html += '<th>⚖️ نوع الحمولة</th>';
            html += '<th>💰 سعر الحمولة</th>';
            html += '<th>💵 الإجمالي</th>';
            html += '</tr></thead>';
            html += '<tbody>';
            
            let totalLoads = 0;
            let totalAmount = 0;
            let fullLoads = 0;
            let halfLoads = 0;
            
            data.forEach(loading => {
                const truck = appData.trucks.find(t => t.id === loading.truckId);
                const truckName = truck ? truck.driverName : '🔴 شاحنة محذوفة';
                const date = new Date(loading.createdAt).toLocaleDateString('ar-SA', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                const loadTypeText = loading.loadType === 'full' ? '🟢 كاملة' : '🟡 نصف';
                const loadTypeBadge = loading.loadType === 'full' ? 'bg-success' : 'bg-warning';
                
                if (loading.loadType === 'full') fullLoads += loading.loadCount;
                else halfLoads += loading.loadCount;
                
                html += `<tr>
                    <td>${date}</td>
                    <td>${truckName}</td>
                    <td><span class="badge bg-info">${loading.loadCount} حملة</span></td>
                    <td><span class="badge ${loadTypeBadge}">${loadTypeText}</span></td>
                    <td>${loading.loadPrice.toFixed(2)} ريال</td>
                    <td><strong class="text-success">${loading.total.toFixed(2)} ريال</strong></td>
                </tr>`;
                
                totalLoads += loading.loadCount;
                totalAmount += loading.total;
            });
            
            html += '</tbody></table></div>';
            
            // إضافة الإحصائيات
            html += `<div class="row mt-4">
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h4>${totalLoads}</h4>
                            <p>📦 إجمالي الحملات</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-dark">
                        <div class="card-body text-center">
                            <h4>${totalAmount.toFixed(2)}</h4>
                            <p>💰 إجمالي القيمة</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h4>${fullLoads}</h4>
                            <p>🟢 حمولة كاملة</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-dark">
                        <div class="card-body text-center">
                            <h4>${halfLoads}</h4>
                            <p>🟡 نصف حمولة</p>
                        </div>
                    </div>
                </div>
            </div>`;
            
            return html;
        }

        // إنشاء تقرير حسابات الشاحنات
        function generateTruckAccountsReport(startDate, truckId) {
            let html = '<h5 class="text-info mb-4">🧾 تقرير حسابات الشاحنات</h5>';
            
            // فلترة الشاحنات
            const filteredTrucks = truckId ? 
                appData.trucks.filter(truck => truck.id == truckId) : 
                appData.trucks;
            
            if (filteredTrucks.length === 0) {
                return '<div class="text-center text-muted"><p>لا توجد شاحنات في الفترة المحددة</p></div>';
            }
            
            html += '<div class="table-responsive">';
            html += '<table class="table table-striped table-hover">';
            html += '<thead class="table-info"><tr>';
            html += '<th>🚛 الشاحنة</th>';
            html += '<th>📞 الهاتف</th>';
            html += '<th>💰 الرصيد الحالي</th>';
            html += '<th>📦 إجمالي الإيرادات</th>';
            html += '<th>💸 إجمالي المدفوعات</th>';
            html += '<th>📊 عدد عمليات التعبئة</th>';
            html += '</tr></thead>';
            html += '<tbody>';
            
            let totalBalance = 0;
            let totalRevenue = 0;
            let totalPayments = 0;
            let totalLoadings = 0;
            
            filteredTrucks.forEach(truck => {
                // حساب إجمالي الإيرادات من عمليات التعبئة
                const truckLoadings = appData.truckLoadings.filter(loading => {
                    const loadingDate = new Date(loading.createdAt);
                    return loading.truckId === truck.id && loadingDate >= startDate;
                });
                const truckRevenue = truckLoadings.reduce((sum, loading) => sum + loading.total, 0);
                
                // حساب إجمالي المدفوعات من السندات
                const truckReceipts = appData.receipts.filter(receipt => {
                    const receiptDate = new Date(receipt.createdAt);
                    return receipt.recipientType === 'truck' && 
                           receipt.truckId === truck.id && 
                           receiptDate >= startDate;
                });
                const truckPayments = truckReceipts.reduce((sum, receipt) => sum + receipt.amount, 0);
                
                const balanceClass = truck.balance > 0 ? 'text-success' : 
                                   truck.balance < 0 ? 'text-danger' : 'text-muted';
                
                html += `<tr>
                    <td><strong>${truck.driverName}</strong><br><small>${truck.truckNumber || 'غير محدد'}</small></td>
                    <td>${truck.phone}</td>
                    <td class="${balanceClass}"><strong>${truck.balance.toFixed(2)} ريال</strong></td>
                    <td class="text-success">${truckRevenue.toFixed(2)} ريال</td>
                    <td class="text-danger">${truckPayments.toFixed(2)} ريال</td>
                    <td><span class="badge bg-info">${truckLoadings.length}</span></td>
                </tr>`;
                
                totalBalance += truck.balance;
                totalRevenue += truckRevenue;
                totalPayments += truckPayments;
                totalLoadings += truckLoadings.length;
            });
            
            html += '</tbody></table></div>';
            
            // إضافة الإحصائيات
            html += `<div class="row mt-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h4>${filteredTrucks.length}</h4>
                            <p>🚛 عدد الشاحنات</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card ${totalBalance >= 0 ? 'bg-success' : 'bg-danger'} text-white">
                        <div class="card-body text-center">
                            <h4>${totalBalance.toFixed(2)}</h4>
                            <p>💰 إجمالي الأرصدة</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h4>${totalRevenue.toFixed(2)}</h4>
                            <p>📦 إجمالي الإيرادات</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-dark">
                        <div class="card-body text-center">
                            <h4>${totalLoadings}</h4>
                            <p>📊 إجمالي العمليات</p>
                        </div>
                    </div>
                </div>
            </div>`;
            
            return html;
        }

        // إنشاء تقرير شامل
        function generateSummaryReport(startDate, customerId, truckId) {
            let html = '<h5 class="text-info mb-4">📈 التقرير الشامل</h5>';
            
            // فلترة البيانات
            const irrigations = appData.irrigations.filter(irrigation => {
                const irrigationDate = new Date(irrigation.createdAt);
                const matchesDate = irrigationDate >= startDate;
                const matchesCustomer = !customerId || irrigation.customerId == customerId;
                return matchesDate && matchesCustomer;
            });
            
            const receipts = appData.receipts.filter(receipt => {
                const receiptDate = new Date(receipt.createdAt);
                const matchesDate = receiptDate >= startDate;
                const matchesCustomer = !customerId || receipt.customerId == customerId;
                const matchesTruck = !truckId || receipt.truckId == truckId;
                return matchesDate && matchesCustomer && matchesTruck;
            });
            
            const truckLoadings = appData.truckLoadings.filter(loading => {
                const loadingDate = new Date(loading.createdAt);
                const matchesDate = loadingDate >= startDate;
                const matchesTruck = !truckId || loading.truckId == truckId;
                return matchesDate && matchesTruck;
            });
            
            // حساب الإجماليات
            const totalIrrigationCost = irrigations.reduce((sum, irrigation) => sum + irrigation.totalCost, 0);
            const totalPayments = receipts.reduce((sum, receipt) => sum + receipt.amount, 0);
            const totalTruckRevenue = truckLoadings.reduce((sum, loading) => sum + loading.total, 0);
            const totalRevenue = totalIrrigationCost + totalTruckRevenue;
            const netBalance = totalRevenue - totalPayments;
            
            // البطاقات الإحصائية
            html += `<div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h3>${appData.customers.length}</h3>
                            <p>👥 العملاء</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h3>${appData.trucks.length}</h3>
                            <p>🚛 الشاحنات</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h3>${irrigations.length}</h3>
                            <p>💧 عمليات الري</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-dark">
                        <div class="card-body text-center">
                            <h3>${truckLoadings.length}</h3>
                            <p>📦 عمليات التعبئة</p>
                        </div>
                    </div>
                </div>
            </div>`;
            
            // الإيرادات والمصروفات
            html += `<div class="row mb-4">
                <div class="col-md-4">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h4>${totalRevenue.toFixed(2)}</h4>
                            <p>💰 إجمالي الإيرادات</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-danger text-white">
                        <div class="card-body text-center">
                            <h4>${totalPayments.toFixed(2)}</h4>
                            <p>💸 إجمالي المدفوعات</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card ${netBalance >= 0 ? 'bg-info' : 'bg-warning'} text-white">
                        <div class="card-body text-center">
                            <h4>${netBalance.toFixed(2)}</h4>
                            <p>⚖️ الرصيد الصافي</p>
                        </div>
                    </div>
                </div>
            </div>`;
            
            // تحليل النسب
            html += `<div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">📊 توزيع الإيرادات</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2">
                                <span>💧 عمليات الري:</span>
                                <strong>${totalIrrigationCost.toFixed(2)} ريال</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>🚛 تعبئة الشاحنات:</span>
                                <strong>${totalTruckRevenue.toFixed(2)} ريال</strong>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">📈 ملخص النشاط</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2">
                                <span>📅 الفترة:</span>
                                <strong>${startDate.toLocaleDateString('ar-SA')} - ${new Date().toLocaleDateString('ar-SA')}</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>🔢 إجمالي المعاملات:</span>
                                <strong>${irrigations.length + receipts.length + truckLoadings.length}</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
            
            return html;
        }

        // تصدير التقرير إلى Excel
        function exportReportExcel() {
            const reportTable = document.querySelector("#reportResults table");
            if (!reportTable) return alert("لا يوجد تقرير لتصديره.");

            const reportTitle = document.getElementById("reportType").selectedOptions[0].text;
            const blob = new Blob(['\ufeff' + reportTable.outerHTML], { type: "application/vnd.ms-excel" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `${reportTitle}.xls`;
            link.click();
        }

        // طباعة التقرير
        function printReport() {
            const reportContent = document.getElementById('reportResults');
            const table = reportContent ? reportContent.querySelector('table') : null;
            
            if (!table) {
                alert("⚠️ لا يوجد تقرير للطباعة!");
                return;
            }

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>طباعة التقرير</title>
                    <style>
                        body { font-family: Arial, sans-serif; direction: rtl; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    ${table.outerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // مشاركة التقرير
        function shareReport() {
            const reportTable = document.querySelector("#reportResults table");
            if (!reportTable) return alert("لا يوجد تقرير للمشاركة.");

            const reportTitle = document.getElementById("reportType").selectedOptions[0].text;
            const reportText = reportTable.innerText;
            
            if (navigator.share) {
                navigator.share({
                    title: reportTitle,
                    text: reportText
                }).catch(console.error);
            } else {
                alert("ميزة المشاركة غير مدعومة في هذا المتصفح.");
            }
        }

        // تصدير PDF
        function exportOrShareReportPDF(event) {
            const reportContent = document.getElementById('reportResults');
            const table = reportContent ? reportContent.querySelector('table') : null;

            if (!table) {
                alert("⚠️ لا يوجد تقرير لتصديره!");
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFont('helvetica');
                doc.setFontSize(16);
                
                const reportTitle = document.getElementById("reportType").selectedOptions[0].text;
                doc.text(reportTitle, 105, 20, { align: 'center' });
                
                doc.autoTable({
                    html: table,
                    startY: 30,
                    styles: { 
                        font: 'helvetica', 
                        fontSize: 9, 
                        cellPadding: 3, 
                        halign: 'center' 
                    },
                    headStyles: { 
                        fillColor: [44, 90, 160], 
                        textColor: 255,
                        fontStyle: 'bold'
                    }
                });
                
                doc.save(`${reportTitle}.pdf`);
                showAlert('تم تصدير التقرير بنجاح', 'success');
                
            } catch (error) {
                console.error('خطأ في تصدير PDF:', error);
                showAlert('حدث خطأ أثناء تصدير التقرير', 'danger');
            }
        }

        // حفظ إعدادات التطبيق
        function saveAppSettings(e) {
            e.preventDefault();
            
            const newAppName = document.getElementById('newAppName').value;
            
            appData.settings.appName = newAppName;
            
            // تطبيق التغييرات
            document.getElementById('appName').textContent = newAppName;
            document.getElementById('loginAppName').textContent = newAppName;
            
            saveData();
            showAlert('تم حفظ إعدادات التطبيق بنجاح', 'success');
        }

        // حفظ إعدادات تسجيل الدخول
        function saveLoginSettings(e) {
            e.preventDefault();
            
            const enableLogin = document.getElementById('enableLogin').checked;
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            
            appData.settings.loginRequired = enableLogin;
            appData.settings.username = username;
            appData.settings.password = password;
            
            document.getElementById('loginRequiredSwitch').checked = enableLogin;
            
            saveData();
            showAlert('تم حفظ إعدادات تسجيل الدخول بنجاح', 'success');
        }

        // حفظ إعدادات الديزل والساعات
        function saveFuelSettings(e) {
            e.preventDefault();
            
            const hourlyRate = parseFloat(document.getElementById('hourlyRate').value);
            const fuelConsumptionRate = parseFloat(document.getElementById('fuelConsumptionRate').value);
            
            appData.settings.hourlyRate = hourlyRate;
            appData.settings.fuelConsumptionRate = fuelConsumptionRate;
            
            saveData();
            showAlert('تم حفظ إعدادات الديزل والساعات بنجاح', 'success');
        }

        // حفظ الإعدادات العامة
        function saveSettings() {
            const fontSize = document.getElementById('fontSizeSelect').value;
            const fontFamily = document.getElementById('fontFamilySelect').value;
            const darkMode = document.getElementById('darkModeSwitch').checked;
            const loginRequired = document.getElementById('loginRequiredSwitch').checked;
            const autoBackup = document.getElementById('autoBackupSwitch').checked;
            
            appData.settings.fontSize = fontSize;
            appData.settings.fontFamily = fontFamily;
            appData.settings.darkMode = darkMode;
            appData.settings.loginRequired = loginRequired;
            appData.settings.autoBackup = autoBackup;
            
            // تطبيق التغييرات
            applySettings();
            
            saveData();
            showAlert('تم حفظ الإعدادات بنجاح', 'success');
        }

        // إنشاء نسخة احتياطية
        function createBackup() {
            try {
                const backupData = {
                    ...appData,
                    truckEncodingSettings: truckEncodingSettings,
                    backupDate: new Date().toISOString(),
                    version: '1.0.0'
                };
                
                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/back'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `bak_amad_${new Date().toISOString().split('T')[0]}.back`;
                link.click();
                
                showAlert('تم إنشاء النسخة الاحتياطية بنجاح', 'success');
            } catch (error) {
                showAlert('حدث خطأ أثناء إنشاء النسخة الاحتياطية', 'danger');
            }
        }

        // استعادة نسخة احتياطية
        function restoreBackup() {
            const fileInput = document.getElementById('backupFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showAlert('يرجى اختيار ملف النسخة الاحتياطية', 'warning');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    // التحقق من صحة البيانات
                    if (!backupData.customers || !backupData.trucks || !backupData.settings) {
                        throw new Error('ملف النسخة الاحتياطية غير صحيح');
                    }
                    
                    // استعادة البيانات
                    appData = { ...appData, ...backupData };
                    
                    // استعادة إعدادات ترميز الشاحنات إذا كانت موجودة
                    if (backupData.truckEncodingSettings) {
                        truckEncodingSettings = backupData.truckEncodingSettings;
                        saveTruckEncodingSettings();
                    }
                    
                    // حفظ البيانات المستعادة
                    saveData();
                    
                    // إعادة تهيئة التطبيق
                    initializeApp();
                    
                    showAlert('تم استعادة النسخة الاحتياطية بنجاح', 'success');
                    
                } catch (error) {
                    showAlert('حدث خطأ أثناء استعادة النسخة الاحتياطية: ' + error.message, 'danger');
                }
            };
            
            reader.readAsText(file);
        }

        // عرض رسالة تنبيه
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 100px; left: 50%; transform: translateX(-50%); z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // إزالة التنبيه تلقائياً بعد 5 ثوان
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        // تسجيل الخروج
        function logout() {
            sessionStorage.removeItem('isLoggedIn');
            showLoginScreen();
            showAlert('تم تسجيل الخروج بنجاح', 'info');
        }

        // تحديث زر تسجيل الخروج
        function updateLogoutButton() {
            if (appData.settings.loginRequired) {
                const navbar = document.querySelector('.navbar .container-fluid .d-flex:last-child');
                if (!document.getElementById('logoutBtn')) {
                    const logoutBtn = document.createElement('button');
                    logoutBtn.id = 'logoutBtn';
                    logoutBtn.className = 'btn btn-outline-light ms-2';
                    logoutBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i>';
                    logoutBtn.title = 'تسجيل الخروج';
                    logoutBtn.onclick = logout;
                    navbar.appendChild(logoutBtn);
                }
            } else {
                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) {
                    logoutBtn.remove();
                }
            }
        }

        // النسخ الاحتياطي التلقائي
        function autoBackup() {
            if (appData.settings.autoBackup) {
                createBackup();
            }
        }

        // تشغيل النسخ الاحتياطي التلقائي كل ساعة
        setInterval(autoBackup, 3600000);

        // حفظ البيانات عند إغلاق النافذة
        window.addEventListener('beforeunload', function() {
            saveData();
            saveTruckEncodingSettings();
        });

        // حفظ البيانات دورياً كل 5 دقائق
        setInterval(saveData, 300000);

        // رسالة الشكر النهائية
        console.log('%c🙏 شكراً لاستخدام تطبيق إدارة الري والشاحنات!', 'color: #28a745; font-size: 16px; font-weight: bold;');
        console.log('%cنتمنى لك تجربة ممتعة ومفيدة مع التطبيق', 'color: #6c757d; font-size: 12px;');
    </script>
</body>
</html>
